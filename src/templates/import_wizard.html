{% extends "base.html" %}
{% block title %}Import Database - Postgres Explorer{% endblock %}
{% block nav_import %}active{% endblock %}
{% block page_title %}Import Database{% endblock %}
{% block content %}

<div class="row" id="import-wizard-root">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="ti ti-upload me-2"></i>Import Wizard</h3>
      </div>
      <div class="card-body">
        <div class="steps steps-counter steps-lime mb-4">
          <a class="step-item active" id="step-1-tab"><span class="h4">1</span> Upload</a>
          <a class="step-item" id="step-2-tab"><span class="h4">2</span> Target</a>
          <a class="step-item" id="step-3-tab"><span class="h4">3</span> Options</a>
          <a class="step-item" id="step-4-tab"><span class="h4">4</span> Execute</a>
        </div>

        <div id="step-1" class="wizard-step">
          <h3 class="mb-3">Upload dump file</h3>
          <div class="card card-body">
            <div class="upload-zone" id="upload-zone"
                 onclick="document.getElementById('file-input').click()"
                 ondragover="event.preventDefault(); this.classList.add('dragover')"
                 ondragleave="this.classList.remove('dragover')"
                 ondrop="event.preventDefault(); this.classList.remove('dragover'); if(event.dataTransfer.files.length > 0) handleFileUpload(event.dataTransfer.files[0])">
              <i class="ti ti-cloud-upload" style="font-size: 48px; color: #999;"></i>
              <h4 class="mt-3">Drag & drop file here</h4>
              <p class="text-muted">or click to browse</p>
              <p class="text-muted small">Max size: 2GB</p>
              <input type="file" id="file-input" style="display: none;" onchange="if(this.files.length > 0) handleFileUpload(this.files[0])">
            </div>
          </div>
          <div id="upload-progress" style="display: none;" class="mt-3">
            <div class="progress"><div class="progress-bar progress-bar-indeterminate bg-green"></div></div>
          </div>
          <div id="upload-success" style="display: none;" class="alert alert-success mt-3">
            <i class="ti ti-check me-2"></i><strong id="uploaded-filename"></strong> uploaded
            <div class="text-muted small">Size: <span id="uploaded-size"></span></div>
          </div>
        </div>

        <div id="step-2" class="wizard-step" style="display: none;">
          <h3 class="mb-3">Target database</h3>
          <div class="mb-3">
            <label class="form-label">Database name</label>
            <input type="text" class="form-control" id="target-database" placeholder="database_name">
            <small class="form-hint">Leave empty to use database from connection</small>
          </div>
          <div class="mb-3">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="create-db">
              <span class="form-check-label">Create database if missing</span>
            </label>
          </div>
          <div class="mb-3">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="clean">
              <span class="form-check-label">Clean before restore (DROP objects)</span>
            </label>
          </div>
        </div>

        <div id="step-3" class="wizard-step" style="display: none;">
          <h3 class="mb-3">Import options</h3>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3"><label class="form-check form-switch"><input class="form-check-input" type="checkbox" id="data-only"><span class="form-check-label">Data only</span></label></div>
              <div class="mb-3"><label class="form-check form-switch"><input class="form-check-input" type="checkbox" id="schema-only"><span class="form-check-label">Schema only</span></label></div>
              <div class="mb-3"><label class="form-check form-switch"><input class="form-check-input" type="checkbox" id="disable-triggers" checked><span class="form-check-label">Disable triggers</span></label></div>
            </div>
            <div class="col-md-6">
              <div class="mb-3"><label class="form-check form-switch"><input class="form-check-input" type="checkbox" id="single-transaction"><span class="form-check-label">Single transaction</span></label></div>
              <div class="mb-3"><label class="form-check form-switch"><input class="form-check-input" type="checkbox" id="verbose-import" checked><span class="form-check-label">Verbose logging</span></label></div>
            </div>
          </div>
        </div>

        <div id="step-4" class="wizard-step" style="display: none;">
          <h3 class="mb-3">Review & Execute</h3>
          <div class="card mb-3">
            <div class="card-header"><h4 class="card-title">Command Preview</h4></div>
            <div class="card-body"><pre id="command-preview-import" class="bg-dark text-white p-3 rounded">pg_restore ...</pre></div>
          </div>
          <div id="import-status" style="display: none;">
            <div class="terminal-window">
              <div class="terminal-header">
                <div class="terminal-controls">
                  <span class="terminal-dot terminal-dot-red"></span>
                  <span class="terminal-dot terminal-dot-yellow"></span>
                  <span class="terminal-dot terminal-dot-green"></span>
                </div>
                <span class="terminal-title">Import Progress</span>
                <div class="terminal-actions">
                  <button class="btn btn-sm btn-ghost-secondary" id="copy-logs-import" onclick="copyLogsImport(this)" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">
                    <i class="ti ti-copy"></i>
                  </button>
                  <button class="btn btn-sm btn-ghost-secondary" onclick="saveLogsImport()" title="Download full log file">
                    <i class="ti ti-file-text"></i>
                  </button>
                </div>
              </div>
              <div class="terminal-body" id="terminal-output-import"></div>
              <div class="terminal-footer">
                <span>Status: <strong id="job-status-import">Running...</strong></span>
                <span class="ms-3">Duration: <strong id="job-duration-import">00:00</strong></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card-footer d-flex justify-content-between">
        <button class="btn btn-secondary" id="btn-prev-import" disabled><i class="ti ti-arrow-left me-1"></i>Previous</button>
        <button class="btn btn-primary" id="btn-next-import" disabled>Next<i class="ti ti-arrow-right ms-1"></i></button>
        <button class="btn btn-success" id="btn-execute-import" style="display: none;" onclick="startImport()"><i class="ti ti-play me-1"></i>Start Import</button>
      </div>
    </div>
  </div>
</div>

<style>
.upload-zone { border: 2px dashed #ccc; border-radius: 8px; padding: 60px 20px; text-align: center; cursor: pointer; }
.upload-zone:hover { border-color: #206bc4; background: rgba(32, 107, 196, 0.05); }
.upload-zone.dragover { border-color: #206bc4; background: rgba(32, 107, 196, 0.1); }
.terminal-window { background: #1e1e1e; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.3); overflow: hidden; }
.terminal-header { background: linear-gradient(180deg, #3c3c3c 0%, #2c2c2c 100%); color: #ccc; padding: 8px 12px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #1a1a1a; }
.terminal-controls { display: flex; gap: 6px; }
.terminal-actions { display: flex; gap: 4px; }
.terminal-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
.terminal-dot-red { background: #ff5f56; }
.terminal-dot-yellow { background: #ffbd2e; }
.terminal-dot-green { background: #27c93f; }
.terminal-title { flex: 1; text-align: center; font-size: 13px; font-weight: 500; }
.terminal-body { background: #1e1e1e; color: #0f0; font-family: Monaco, Menlo, monospace; font-size: 13px; padding: 12px; height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; }
.terminal-footer { background: #2c2c2c; color: #999; padding: 8px 12px; font-size: 12px; display: flex; align-items: center; gap: 12px; }
.wizard-step { min-height: 400px; }
</style>
{% endblock %}
