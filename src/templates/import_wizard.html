{% extends "base.html" %}
{% block title %}Import Database - Postgres Explorer{% endblock %}
{% block nav_import %}active{% endblock %}
{% block page_title %}Import Database{% endblock %}
{% block content %}

<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="ti ti-upload me-2"></i>Import Wizard</h3>
      </div>
      <div class="card-body">
        <div class="steps steps-counter steps-lime mb-4">
          <a class="step-item active" id="step-1-tab"><span class="h4">1</span> Upload</a>
          <a class="step-item" id="step-2-tab"><span class="h4">2</span> Target</a>
          <a class="step-item" id="step-3-tab"><span class="h4">3</span> Options</a>
          <a class="step-item" id="step-4-tab"><span class="h4">4</span> Execute</a>
        </div>

        <div id="step-1" class="wizard-step">
          <h3 class="mb-3">Upload dump file</h3>
          <div class="card card-body bg-light">
            <div class="upload-zone" id="upload-zone"
                 onclick="document.getElementById('file-input').click()"
                 ondragover="event.preventDefault(); this.classList.add('dragover')"
                 ondragleave="this.classList.remove('dragover')"
                 ondrop="event.preventDefault(); this.classList.remove('dragover'); if(event.dataTransfer.files.length > 0) handleFileUpload(event.dataTransfer.files[0])">
              <i class="ti ti-cloud-upload" style="font-size: 48px; color: #999;"></i>
              <h4 class="mt-3">Drag & drop file here</h4>
              <p class="text-muted">or click to browse</p>
              <p class="text-muted small">Max size: 2GB</p>
              <input type="file" id="file-input" style="display: none;" onchange="if(this.files.length > 0) handleFileUpload(this.files[0])">
            </div>
          </div>
          <div id="upload-progress" style="display: none;" class="mt-3">
            <div class="progress"><div class="progress-bar progress-bar-indeterminate bg-green"></div></div>
          </div>
          <div id="upload-success" style="display: none;" class="alert alert-success mt-3">
            <i class="ti ti-check me-2"></i><strong id="uploaded-filename"></strong> uploaded
            <div class="text-muted small">Size: <span id="uploaded-size"></span></div>
          </div>
        </div>

        <div id="step-2" class="wizard-step" style="display: none;">
          <h3 class="mb-3">Target database</h3>
          <div class="mb-3">
            <label class="form-label">Database name</label>
            <input type="text" class="form-control" id="target-database" placeholder="database_name">
            <small class="form-hint">Leave empty to use database from connection</small>
          </div>
          <div class="mb-3">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="create-db">
              <span class="form-check-label">Create database if missing</span>
            </label>
          </div>
          <div class="mb-3">
            <label class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="clean">
              <span class="form-check-label">Clean before restore (DROP objects)</span>
            </label>
          </div>
        </div>

        <div id="step-3" class="wizard-step" style="display: none;">
          <h3 class="mb-3">Import options</h3>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3"><label class="form-check form-switch"><input class="form-check-input" type="checkbox" id="data-only"><span class="form-check-label">Data only</span></label></div>
              <div class="mb-3"><label class="form-check form-switch"><input class="form-check-input" type="checkbox" id="schema-only"><span class="form-check-label">Schema only</span></label></div>
              <div class="mb-3"><label class="form-check form-switch"><input class="form-check-input" type="checkbox" id="disable-triggers" checked><span class="form-check-label">Disable triggers</span></label></div>
            </div>
            <div class="col-md-6">
              <div class="mb-3"><label class="form-check form-switch"><input class="form-check-input" type="checkbox" id="single-transaction"><span class="form-check-label">Single transaction</span></label></div>
              <div class="mb-3"><label class="form-check form-switch"><input class="form-check-input" type="checkbox" id="verbose-import" checked><span class="form-check-label">Verbose logging</span></label></div>
            </div>
          </div>
        </div>

        <div id="step-4" class="wizard-step" style="display: none;">
          <h3 class="mb-3">Review & Execute</h3>
          <div class="card mb-3">
            <div class="card-header"><h4 class="card-title">Command Preview</h4></div>
            <div class="card-body"><pre id="command-preview-import" class="bg-dark text-white p-3 rounded">pg_restore ...</pre></div>
          </div>
          <div id="import-status" style="display: none;">
            <div class="terminal-window">
              <div class="terminal-header">
                <div class="terminal-controls">
                  <span class="terminal-dot terminal-dot-red"></span>
                  <span class="terminal-dot terminal-dot-yellow"></span>
                  <span class="terminal-dot terminal-dot-green"></span>
                </div>
                <span class="terminal-title">Import Progress</span>
                <div class="terminal-actions">
                  <button class="btn btn-sm btn-ghost-secondary" id="copy-logs-import" onclick="copyLogsImport(this)" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">
                    <i class="ti ti-copy"></i>
                  </button>
                  <button class="btn btn-sm btn-ghost-secondary" onclick="saveLogsImport()">
                    <i class="ti ti-download"></i>
                  </button>
                </div>
              </div>
              <div class="terminal-body" id="terminal-output-import"></div>
              <div class="terminal-footer">
                <span>Status: <strong id="job-status-import">Running...</strong></span>
                <span class="ms-3">Duration: <strong id="job-duration-import">00:00</strong></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card-footer d-flex justify-content-between">
        <button class="btn btn-secondary" id="btn-prev-import" disabled onclick="if(currentStep > 1) { currentStep--; updateStepImport(); }"><i class="ti ti-arrow-left me-1"></i>Previous</button>
        <button class="btn btn-primary" id="btn-next-import" disabled onclick="if(currentStep < 4) { currentStep++; updateStepImport(); }">Next<i class="ti ti-arrow-right ms-1"></i></button>
        <button class="btn btn-success" id="btn-execute-import" style="display: none;" onclick="startImport()"><i class="ti ti-play me-1"></i>Start Import</button>
      </div>
    </div>
  </div>
</div>

<style>
.upload-zone { border: 2px dashed #ccc; border-radius: 8px; padding: 60px 20px; text-align: center; cursor: pointer; }
.upload-zone:hover { border-color: #206bc4; background: rgba(32, 107, 196, 0.05); }
.upload-zone.dragover { border-color: #206bc4; background: rgba(32, 107, 196, 0.1); }
.terminal-window { background: #1e1e1e; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.3); overflow: hidden; }
.terminal-header { background: linear-gradient(180deg, #3c3c3c 0%, #2c2c2c 100%); color: #ccc; padding: 8px 12px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #1a1a1a; }
.terminal-controls { display: flex; gap: 6px; }
.terminal-actions { display: flex; gap: 4px; }
.terminal-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
.terminal-dot-red { background: #ff5f56; }
.terminal-dot-yellow { background: #ffbd2e; }
.terminal-dot-green { background: #27c93f; }
.terminal-title { flex: 1; text-align: center; font-size: 13px; font-weight: 500; }
.terminal-body { background: #1e1e1e; color: #0f0; font-family: Monaco, Menlo, monospace; font-size: 13px; padding: 12px; height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; }
.terminal-footer { background: #2c2c2c; color: #999; padding: 8px 12px; font-size: 12px; display: flex; align-items: center; gap: 12px; }
.wizard-step { min-height: 400px; }
</style>

<script>
const basePath = '{% if ctx.base_path == "/" %}{% else %}{{ ctx.base_path }}{% endif %}';
let currentStep = 1, jobId = null, eventSource = null, startTime = null, durationInterval = null, uploadedFilePath = null, uploadedFormat = null;

async function handleFileUpload(file) {
  document.getElementById('upload-progress').style.display = 'block';
  document.getElementById('upload-success').style.display = 'none';
  const formData = new FormData();
  formData.append('file', file);
  try {
    const response = await fetch(`${basePath}/maintenance/import/upload`, { method: 'POST', body: formData });
    if (!response.ok) {
      const text = await response.text();
      throw new Error(`HTTP ${response.status}: ${text}`);
    }
    const data = await response.json();
    uploadedFilePath = data.file_path;
    uploadedFormat = data.format;
    document.getElementById('upload-progress').style.display = 'none';
    document.getElementById('upload-success').style.display = 'block';
    document.getElementById('uploaded-filename').textContent = file.name;
    document.getElementById('uploaded-size').textContent = (data.file_size / 1024 / 1024).toFixed(2) + ' MB (' + data.format + ')';
    document.getElementById('btn-next-import').disabled = false;
  } catch (err) {
    document.getElementById('upload-progress').style.display = 'none';
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-danger mt-3';
    errorDiv.innerHTML = '<i class="ti ti-alert-circle me-2"></i><strong>Upload failed:</strong> ' + err.message;
    document.getElementById('upload-success').parentElement.appendChild(errorDiv);
    console.error('Upload error:', err);
  }
}

function updateStepImport() {
  for (let i = 1; i <= 4; i++) {
    document.getElementById(`step-${i}`).style.display = 'none';
    document.getElementById(`step-${i}-tab`).classList.remove('active');
  }
  document.getElementById(`step-${currentStep}`).style.display = 'block';
  document.getElementById(`step-${currentStep}-tab`).classList.add('active');
  document.getElementById('btn-prev-import').disabled = currentStep === 1;
  document.getElementById('btn-next-import').style.display = currentStep === 4 ? 'none' : 'inline-block';
  document.getElementById('btn-execute-import').style.display = currentStep === 4 ? 'inline-block' : 'none';
  if (currentStep === 4) updateCommandPreviewImport();
}

function updateCommandPreviewImport() {
  const isPlain = uploadedFormat === 'plain';
  const db = document.getElementById('target-database').value || '[database]';

  if (isPlain) {
    let cmd = 'PGPASSWORD=***** psql -h [host] -p [port] -U [user] -d ' + db;
    if (document.getElementById('single-transaction').checked) cmd += ' --single-transaction';
    cmd += ' -f [file]';
    document.getElementById('command-preview-import').textContent = cmd;
  } else {
    const createDb = document.getElementById('create-db').checked;
    let cmd = 'PGPASSWORD=***** pg_restore -h [host] -p [port] -U [user]';

    // If --create, connect to maintenance DB and use --dbname
    if (createDb) {
      cmd += ' -d [maintenance_db] --dbname ' + db;
    } else {
      cmd += ' -d ' + db;
    }

    if (document.getElementById('clean').checked) cmd += ' --clean';
    if (createDb) cmd += ' --create';
    if (document.getElementById('data-only').checked) cmd += ' --data-only';
    if (document.getElementById('schema-only').checked) cmd += ' --schema-only';
    if (document.getElementById('disable-triggers').checked) cmd += ' --disable-triggers';
    if (document.getElementById('single-transaction').checked) cmd += ' --single-transaction';
    if (document.getElementById('verbose-import').checked) cmd += ' --verbose';
    cmd += ' --no-owner [file]';
    document.getElementById('command-preview-import').textContent = cmd;
  }
}

async function startImport() {
  if (!uploadedFilePath) { alert('No file uploaded'); return; }
  const payload = {
    file_path: uploadedFilePath,
    format: uploadedFormat,
    target_database: document.getElementById('target-database').value,
    clean: document.getElementById('clean').checked,
    create_db: document.getElementById('create-db').checked,
    data_only: document.getElementById('data-only').checked,
    schema_only: document.getElementById('schema-only').checked,
    disable_triggers: document.getElementById('disable-triggers').checked,
    single_transaction: document.getElementById('single-transaction').checked,
    verbose: document.getElementById('verbose-import').checked,
    pg_version: 'auto'
  };
  document.getElementById('btn-execute-import').disabled = true;
  document.getElementById('import-status').style.display = 'block';
  try {
    const response = await fetch(`${basePath}/maintenance/import`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    const data = await response.json();
    jobId = data.job_id;
    startLogStreamImport(jobId);
    startDurationTimerImport();
  } catch (err) {
    appendTerminalImport(`ERROR: ${err.message}`, 'red');
    document.getElementById('job-status-import').textContent = 'Failed';
  }
}

function startLogStreamImport(jobId) {
  eventSource = new EventSource(`${basePath}/maintenance/import/${jobId}/logs`);
  eventSource.onmessage = (event) => appendTerminalImport(event.data);
  eventSource.onerror = () => { eventSource.close(); checkJobStatusImport(jobId); };
}

async function checkJobStatusImport(jobId) {
  try {
    const response = await fetch(`${basePath}/maintenance/import/${jobId}/status`);
    const data = await response.json();
    const statusEl = document.getElementById('job-status-import');
    statusEl.textContent = data.status;
    if (data.status === 'Completed') { if (durationInterval) clearInterval(durationInterval); statusEl.style.color = '#27c93f'; }
    else if (data.status === 'Failed') { if (durationInterval) clearInterval(durationInterval); statusEl.style.color = '#ff5f56'; if (data.error) appendTerminalImport('FAILED: ' + data.error, '#ff5f56'); }
  } catch (err) { console.error('Failed to check status:', err); }
}

function appendTerminalImport(text, color = '#0f0') {
  const terminal = document.getElementById('terminal-output-import');
  const line = document.createElement('div');
  line.style.color = color;
  line.textContent = text;
  terminal.appendChild(line);
  terminal.scrollTop = terminal.scrollHeight;
}

function startDurationTimerImport() {
  startTime = Date.now();
  durationInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    document.getElementById('job-duration-import').textContent = Math.floor(elapsed / 60).toString().padStart(2, '0') + ':' + (elapsed % 60).toString().padStart(2, '0');
  }, 1000);
}

document.getElementById('copy-logs-import').addEventListener('click', function() {
  const terminal = document.getElementById('terminal-output-import');
  const text = Array.from(terminal.children).map(line => line.textContent).join('\n');
  navigator.clipboard.writeText(text).then(() => {
    this.setAttribute('title', 'Copied!');
    const tooltip = new bootstrap.Tooltip(this, { trigger: 'manual' });
    tooltip.show();
    setTimeout(() => { tooltip.dispose(); this.setAttribute('title', ''); }, 2000);
  }).catch(err => {
    console.error('Failed to copy:', err);
  });
});

document.getElementById('save-logs-import').addEventListener('click', () => {
  const terminal = document.getElementById('terminal-output-import');
  const text = Array.from(terminal.children).map(line => line.textContent).join('\n');
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `import_${jobId}_log.txt`;
  a.click();
  URL.revokeObjectURL(url);
});

function copyLogsImport(btn) {
  const terminal = document.getElementById('terminal-output-import');
  const text = Array.from(terminal.children).map(line => line.textContent).join('\n');
  navigator.clipboard.writeText(text).then(() => {
    btn.setAttribute('title', 'Copied!');
    const tooltip = new bootstrap.Tooltip(btn, { trigger: 'manual' });
    tooltip.show();
    setTimeout(() => { tooltip.dispose(); btn.setAttribute('title', ''); }, 2000);
  }).catch(err => console.error('Failed to copy:', err));
}

function saveLogsImport() {
  const terminal = document.getElementById('terminal-output-import');
  const text = Array.from(terminal.children).map(line => line.textContent).join('\n');
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `import_${jobId}_log.txt`;
  a.click();
  URL.revokeObjectURL(url);
}
</script>

{% endblock %}
