{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}
{% block nav_schemas %}active{% endblock %}
{% block page_title %}Schemas{% endblock %}
{% block page_subtitle %}
<div class="page-pretitle">
    Total {{ total_count }} schemas
</div>
{% endblock %}
{% block content %}

<!-- Filter -->
<div class="row row-cards mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-end g-2">
                    <div class="col">
                        <label class="form-label">Schemas filter - wildcard supports *, use OR (or ','), use AND NOT (or '-')</label>
                        <input
                            type="text"
                            class="form-control"
                            id="filter-input"
                            name="filter"
                            placeholder="např: public, user_* -test"
                            value="{{ filter }}"
                            oninput="handleSchemasFilter(this)">
                    </div>
                    <div class="col-auto">
                        <label class="form-label">Per page</label>
                        <select
                            class="form-select"
                            name="per_page"
                            id="per-page-select"
                            onchange="applySchemasPerPageChange()">
                            <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                            <option value="250" {% if per_page == 250 %}selected{% endif %}>250</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<input type="hidden" name="sort_by" value="{{ sort_by }}">
<input type="hidden" name="sort_order" value="{{ sort_order }}">

<!-- Schemas table -->
<div class="row row-cards">
    <div class="col-12">
        <div id="schemas-table">
            <div class="card" data-fetching="{% if is_fetching %}true{% else %}false{% endif %}">
                {% if is_fetching %}
                <div class="card-alert alert alert-info">
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    Fetching data…
                </div>
                {% endif %}
                <div class="table-responsive">
                    <table class="table table-vcenter card-table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th class="sortable" data-sort="name">
                                    Schema
                                    {% if sort_by == "name" %}
                                        {% if sort_order == "asc" %}
                                            <i class="ti ti-chevron-up"></i>
                                        {% else %}
                                            <i class="ti ti-chevron-down"></i>
                                        {% endif %}
                                    {% endif %}
                                </th>
                                <th class="sortable" data-sort="tables">
                                    Tables
                                    {% if sort_by == "tables" %}
                                        {% if sort_order == "asc" %}
                                            <i class="ti ti-chevron-up"></i>
                                        {% else %}
                                            <i class="ti ti-chevron-down"></i>
                                        {% endif %}
                                    {% endif %}
                                </th>
                                <th class="sortable" data-sort="indexes">
                                    Indexes
                                    {% if sort_by == "indexes" %}
                                        {% if sort_order == "asc" %}
                                            <i class="ti ti-chevron-up"></i>
                                        {% else %}
                                            <i class="ti ti-chevron-down"></i>
                                        {% endif %}
                                    {% endif %}
                                </th>
                                <th class="sortable" data-sort="size">
                                    Total Size
                                    {% if sort_by == "size" %}
                                        {% if sort_order == "asc" %}
                                            <i class="ti ti-chevron-up"></i>
                                        {% else %}
                                            <i class="ti ti-chevron-down"></i>
                                        {% endif %}
                                    {% endif %}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                        {% if schemas.len() == 0 %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    No schemas match your filter
                                </td>
                            </tr>
                        {% else %}
                            {% for s in schemas %}
                            <tr style="cursor: pointer;" onclick="window.location='/tables/{{ s.name }}/*'">
                                <td class="text-muted">{{ s.num }}</td>
                                <td><a href="/tables/{{ s.name }}/*">{{ s.name }}</a></td>
                                <td>{{ s.table_count }}</td>
                                <td>{{ s.index_count }}</td>
                                <td>{{ s.total_size }}</td>
                            </tr>
                            {% endfor %}
                        {% endif %}
                        </tbody>
                    </table>
                </div>
                {% if filtered_count > 0 %}
                <div class="card-footer d-flex align-items-center">
                    <p class="m-0 text-muted">
                        Showing {{ showing_start }} - {{ showing_end }} of {{ filtered_count }}
                        {% if filtered_count != total_count %}
                            ({{ total_count }} total)
                        {% endif %}
                    </p>
                    {% if total_pages > 1 %}
                    <ul class="pagination m-0 ms-auto">
                        {% if page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="#"
                               hx-get="/schemas/table?filter={{ filter }}&page={{ page - 1 }}&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                               hx-target="#schemas-table"
                               hx-swap="outerHTML">
                                <i class="ti ti-chevron-left"></i> Prev
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="ti ti-chevron-left"></i> Prev</span>
                        </li>
                        {% endif %}

                        {% if page > 2 %}
                        <li class="page-item">
                            <a class="page-link" href="#"
                               hx-get="/schemas/table?filter={{ filter }}&page=1&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                               hx-target="#schemas-table"
                               hx-swap="outerHTML">
                                1
                            </a>
                        </li>
                        {% if page > 3 %}
                        <li class="page-item disabled"><span class="page-link">…</span></li>
                        {% endif %}
                        {% endif %}

                        {% if page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="#"
                               hx-get="/schemas/table?filter={{ filter }}&page={{ page - 1 }}&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                               hx-target="#schemas-table"
                               hx-swap="outerHTML">
                                {{ page - 1 }}
                            </a>
                        </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">{{ page }}</span>
                        </li>

                        {% if page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="#"
                               hx-get="/schemas/table?filter={{ filter }}&page={{ page + 1 }}&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                               hx-target="#schemas-table"
                               hx-swap="outerHTML">
                                {{ page + 1 }}
                            </a>
                        </li>
                        {% endif %}

                        {% if page < total_pages - 1 %}
                        {% if page < total_pages - 2 %}
                        <li class="page-item disabled"><span class="page-link">…</span></li>
                        {% endif %}
                        <li class="page-item">
                            <a class="page-link" href="#"
                               hx-get="/schemas/table?filter={{ filter }}&page={{ total_pages }}&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                               hx-target="#schemas-table"
                               hx-swap="outerHTML">
                                {{ total_pages }}
                            </a>
                        </li>
                        {% endif %}

                        {% if page < total_pages %}
                        <li class="page-item">
                            <a class="page-link" href="#"
                               hx-get="/schemas/table?filter={{ filter }}&page={{ page + 1 }}&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                               hx-target="#schemas-table"
                               hx-swap="outerHTML">
                                Next <i class="ti ti-chevron-right"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Next <i class="ti ti-chevron-right"></i></span>
                        </li>
                        {% endif %}
                    </ul>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Filter + per page using fetch to avoid htmx swap bugs
if (typeof window.schemasFilterTimer === 'undefined') {
    window.schemasFilterTimer = null;
}

function loadSchemas(url) {
    const target = document.getElementById('schemas-table');
    if (!target) return;
    fetch(url, { method: 'GET' })
        .then(r => r.text())
        .then(html => {
            target.innerHTML = html;
            if (target.querySelector('[data-fetching="true"]')) {
                setTimeout(() => loadSchemas(url), 1000);
            }
        })
        .catch(err => { target.innerHTML = `<div class="text-danger">Failed to load schemas: ${err}</div>`; });
}

function handleSchemasFilter(input) {
    clearTimeout(window.schemasFilterTimer);
    window.schemasFilterTimer = setTimeout(() => {
        const filter = (input.value || '*').trim() || '*';
        const perPage = document.getElementById('per-page-select').value;
        const sortBy = document.querySelector('[name="sort_by"]').value || 'name';
        const sortOrder = document.querySelector('[name="sort_order"]').value || 'asc';
        const base = window.__BASE_PATH__ || '';
        loadSchemas(`${base}/schemas/table?filter=${encodeURIComponent(filter)}&page=1&per_page=${perPage}&sort_by=${sortBy}&sort_order=${sortOrder}`);
    }, 400);
}

function applySchemasPerPageChange() {
    const filter = (document.getElementById('filter-input').value || '*').trim() || '*';
    const perPage = document.getElementById('per-page-select').value;
    const sortBy = document.querySelector('[name="sort_by"]').value || 'name';
    const sortOrder = document.querySelector('[name="sort_order"]').value || 'asc';
    const base = window.__BASE_PATH__ || '';
    loadSchemas(`${base}/schemas/table?filter=${encodeURIComponent(filter)}&page=1&per_page=${perPage}&sort_by=${sortBy}&sort_order=${sortOrder}`);
}

// Sort headers use fetch as well
document.querySelectorAll('.sortable').forEach(th => {
    th.style.cursor = 'pointer';
    th.addEventListener('click', function() {
        const sortBy = this.dataset.sort;
        const currentSortBy = document.querySelector('[name="sort_by"]').value || 'name';
        const currentSortOrder = document.querySelector('[name="sort_order"]').value || 'asc';

        let newSortOrder = 'asc';
        if (sortBy === currentSortBy && currentSortOrder === 'asc') {
            newSortOrder = 'desc';
        }

        document.querySelector('[name="sort_by"]').value = sortBy;
        document.querySelector('[name="sort_order"]').value = newSortOrder;

        const filter = (document.getElementById('filter-input').value || '*').trim() || '*';
        const perPage = document.getElementById('per-page-select').value;
        const base = window.__BASE_PATH__ || '';
        loadSchemas(`${base}/schemas/table?filter=${encodeURIComponent(filter)}&page=1&per_page=${perPage}&sort_by=${sortBy}&sort_order=${newSortOrder}`);
    });
});

// Delegated pagination clicks (hx-get)
document.addEventListener('click', function(evt) {
    const el = evt.target.closest('[hx-get]');
    if (!el) return;
    if (!el.closest('#schemas-table')) return;
    const url = el.getAttribute('hx-get');
    if (!url) return;
    evt.preventDefault();
    loadSchemas(url);
});

{
    const target = document.getElementById('schemas-table');
    if (target && target.querySelector('[data-fetching="true"]')) {
        const filter = (document.getElementById('filter-input').value || '*').trim() || '*';
        const perPage = document.getElementById('per-page-select').value;
        const sortBy = document.querySelector('[name="sort_by"]').value || 'name';
        const sortOrder = document.querySelector('[name="sort_order"]').value || 'asc';
        const base = window.__BASE_PATH__ || '';
        loadSchemas(`${base}/schemas/table?filter=${encodeURIComponent(filter)}&page=1&per_page=${perPage}&sort_by=${sortBy}&sort_order=${sortOrder}`);
    }
}
</script>

{% endblock %}
