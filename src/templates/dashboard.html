{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}
{% block nav_dashboard %}active{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block content %}

<!-- První řada - základní info -->
<div class="row row-deck row-cards mb-3">
  <div class="col-md-3">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="subheader">Server</div>
        </div>
        <div class="h3 mb-0">{{ server_name }}</div>
        <div class="text-muted small">{{ server_version }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="subheader">Database size</div>
        </div>
        <div class="h2 mb-0">{{ db_size }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="subheader">Schemas</div>
        </div>
        <div class="h2 mb-0">{{ schema_count }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="subheader">Tables</div>
        </div>
        <div class="h2 mb-0">{{ table_count }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="subheader">Indexes</div>
        </div>
        <div class="h2 mb-0">{{ index_count }}</div>
      </div>
    </div>
  </div>
</div>

<!-- Druhá řada - metriky s progress bary -->
<div class="row row-deck row-cards mb-3">
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center mb-3">
          <div class="subheader">Cache Hit Ratio</div>
          <div class="ms-auto">
            <span class="text-muted">{{ cache_hit_ratio_text }}</span>
          </div>
        </div>
        <div class="progress progress-sm">
          {% if cache_hit_ratio >= 95.0 %}
          <div class="progress-bar bg-success" style="width: {{ cache_hit_ratio }}%" role="progressbar" aria-valuenow="{{ cache_hit_ratio }}" aria-valuemin="0" aria-valuemax="100"></div>
          {% else if cache_hit_ratio >= 90.0 %}
          <div class="progress-bar bg-warning" style="width: {{ cache_hit_ratio }}%" role="progressbar" aria-valuenow="{{ cache_hit_ratio }}" aria-valuemin="0" aria-valuemax="100"></div>
          {% else %}
          <div class="progress-bar bg-danger" style="width: {{ cache_hit_ratio }}%" role="progressbar" aria-valuenow="{{ cache_hit_ratio }}" aria-valuemin="0" aria-valuemax="100"></div>
          {% endif %}
        </div>
        <div class="text-muted small mt-1">
          {% if cache_hit_ratio >= 95.0 %}
          <i class="ti ti-circle-check text-success"></i> Excellent - most data served from cache
          {% else if cache_hit_ratio >= 90.0 %}
          <i class="ti ti-alert-triangle text-warning"></i> Good - consider tuning shared_buffers
          {% else %}
          <i class="ti ti-alert-circle text-danger"></i> Low - increase shared_buffers or investigate queries
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center mb-3">
          <div class="subheader">Active Connections</div>
          <div class="ms-auto">
            <span class="text-muted">{{ connections_text }}</span>
          </div>
        </div>
        <div class="progress progress-sm">
          {% if connections_percent < 50.0 %}
          <div class="progress-bar bg-success" style="width: {{ connections_percent }}%" role="progressbar" aria-valuenow="{{ connections_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
          {% else if connections_percent < 80.0 %}
          <div class="progress-bar bg-warning" style="width: {{ connections_percent }}%" role="progressbar" aria-valuenow="{{ connections_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
          {% else %}
          <div class="progress-bar bg-danger" style="width: {{ connections_percent }}%" role="progressbar" aria-valuenow="{{ connections_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
          {% endif %}
        </div>
        <div class="text-muted small mt-1">
          {% if connections_percent < 50.0 %}
          <i class="ti ti-circle-check text-success"></i> Healthy - plenty of capacity available
          {% else if connections_percent < 80.0 %}
          <i class="ti ti-alert-triangle text-warning"></i> Monitor - approaching connection limit
          {% else %}
          <i class="ti ti-alert-circle text-danger"></i> Critical - near max_connections limit
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Třetí řada - Top 10 tables -->
<div class="row row-cards">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Top 10 Tables by Size</h3>
      </div>
      <div class="table-responsive">
        <table class="table table-vcenter card-table table-hover">
          <thead>
            <tr>
              <th style="width: 50px;">#</th>
              <th>Schema</th>
              <th>Table</th>
              <th>Rows</th>
              <th>Size</th>
              <th style="width: 200px;">Relative Size</th>
            </tr>
          </thead>
          <tbody>
            {% if top_tables.len() == 0 %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4">
                No tables found
              </td>
            </tr>
            {% else %}
              {% for t in top_tables %}
              <tr>
                <td class="text-muted">{{ loop.index }}</td>
                <td><a class="text-decoration-none" href="{{ t.schema_filter_url }}">{{ t.schema }}</a></td>
                <td>
                  <div><a class="text-decoration-none" href="{{ t.table_filter_url }}" hx-boost="false">{{ t.name }}</a></div>
                  {% if t.partitions.len() > 0 %}
                  <div class="text-muted small mt-1">
                    <i class="ti ti-layout-distribute-vertical"></i>
                    {{ t.partitions.len() }} partitions: {{ t.partitions|join(", ") }}
                  </div>
                  {% endif %}
                </td>
                <td class="text-end text-nowrap">
                  {% if t.stats_stale %}
                  <span class="badge bg-yellow-lt me-2" style="cursor: pointer;" onclick="showAnalyzeModal('{{ t.schema }}', '{{ t.name }}')" title="Statistics are stale. Click to run ANALYZE.">
                    <i class="ti ti-alert-triangle me-1"></i>stats stale
                  </span>
                  {% endif %}
                  {{ t.rows }}
                </td>
                <td class="text-end text-nowrap">{{ t.size }}</td>
                <td>
                  <div class="progress progress-sm">
                    <div class="progress-bar bg-primary" style="width: {{ t.relative_percent }}%; min-width: 2px; opacity: 1;" role="progressbar" title="{{ t.relative_percent }}%"></div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal pro ANALYZE -->
<div class="modal modal-blur fade" id="analyze-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Stale Statistics Detected</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <strong>Table:</strong> <code id="analyze-table-name"></code>
        </div>
        <p>
          PostgreSQL's query planner relies on statistics to make optimal decisions.
          This table shows <span class="badge bg-yellow-lt">0 rows</span> in statistics but has actual data.
        </p>
        <p>
          Running <code>ANALYZE</code> will update the statistics, which helps PostgreSQL:
        </p>
        <ul>
          <li>Choose better query plans</li>
          <li>Optimize index usage</li>
          <li>Improve query performance</li>
        </ul>
        <div class="alert alert-info">
          <i class="ti ti-info-circle me-2"></i>
          <code>ANALYZE</code> is a read-only operation that samples table data. It's safe and typically fast.
        </div>
        <div id="analyze-result" class="mt-3" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="run-analyze-btn" onclick="runAnalyze()">
          <i class="ti ti-refresh me-1"></i>Run ANALYZE
        </button>
      </div>
    </div>
  </div>
</div>

<script>
let currentAnalyzeSchema = '';
let currentAnalyzeTable = '';

function showAnalyzeModal(schema, table) {
  currentAnalyzeSchema = schema;
  currentAnalyzeTable = table;
  document.getElementById('analyze-table-name').textContent = schema + '.' + table;
  document.getElementById('analyze-result').style.display = 'none';
  document.getElementById('run-analyze-btn').disabled = false;
  new bootstrap.Modal(document.getElementById('analyze-modal')).show();
}

function runAnalyze() {
  const btn = document.getElementById('run-analyze-btn');
  const resultDiv = document.getElementById('analyze-result');

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Running...';

  const basePath = '{{ ctx.base_path }}' === '/' ? '' : '{{ ctx.base_path }}';
  fetch(basePath + '/analyze/' + encodeURIComponent(currentAnalyzeSchema) + '/' + encodeURIComponent(currentAnalyzeTable), {
    method: 'POST'
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      resultDiv.innerHTML = '<div class="alert alert-success"><i class="ti ti-check me-2"></i>ANALYZE completed successfully! Statistics have been updated.</div>';
      resultDiv.style.display = 'block';

      // Po 2 sekundách reload stránku
      setTimeout(() => {
        window.location.reload();
      }, 2000);
    } else {
      resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>Failed: ' + (data.error || 'Unknown error') + '</div>';
      resultDiv.style.display = 'block';
      btn.disabled = false;
      btn.innerHTML = '<i class="ti ti-refresh me-1"></i>Run ANALYZE';
    }
  })
  .catch(err => {
    resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>Error: ' + err.message + '</div>';
    resultDiv.style.display = 'block';
    btn.disabled = false;
    btn.innerHTML = '<i class="ti ti-refresh me-1"></i>Run ANALYZE';
  });
}
</script>

{% endblock %}
