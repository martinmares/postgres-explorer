<div id="tables-table" data-sort-by="{{ sort_by }}" data-sort-order="{{ sort_order }}">
    <div class="card">
        <div class="table-responsive">
            <table class="table table-vcenter card-table table-hover">
                <thead>
                    <tr>
                        <th style="width: 50px;">#</th>
                        <th class="sortable" data-sort="schema">
                            Schema
                            {% if sort_by == "schema" %}
                                {% if sort_order == "asc" %}
                                    <i class="ti ti-chevron-up"></i>
                                {% else %}
                                    <i class="ti ti-chevron-down"></i>
                                {% endif %}
                            {% endif %}
                        </th>
                        <th class="sortable" data-sort="name">
                            Table
                            {% if sort_by == "name" %}
                                {% if sort_order == "asc" %}
                                    <i class="ti ti-chevron-up"></i>
                                {% else %}
                                    <i class="ti ti-chevron-down"></i>
                                {% endif %}
                            {% endif %}
                        </th>
                        <th class="sortable" data-sort="rows">
                            Rows
                            {% if sort_by == "rows" %}
                                {% if sort_order == "asc" %}
                                    <i class="ti ti-chevron-up"></i>
                                {% else %}
                                    <i class="ti ti-chevron-down"></i>
                                {% endif %}
                            {% endif %}
                        </th>
                        <th class="sortable" data-sort="size">
                            Size
                            {% if sort_by == "size" %}
                                {% if sort_order == "asc" %}
                                    <i class="ti ti-chevron-up"></i>
                                {% else %}
                                    <i class="ti ti-chevron-down"></i>
                                {% endif %}
                            {% endif %}
                        </th>
                        <th class="sortable" data-sort="indexes">
                            Indexes
                            {% if sort_by == "indexes" %}
                                {% if sort_order == "asc" %}
                                    <i class="ti ti-chevron-up"></i>
                                {% else %}
                                    <i class="ti ti-chevron-down"></i>
                                {% endif %}
                            {% endif %}
                        </th>
                        <th class="w-1"></th>
                    </tr>
                </thead>
                <tbody>
                {% if tables.len() == 0 %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            No tables match your filter
                        </td>
                    </tr>
                {% else %}
                    {% for t in tables %}
                    <tr>
                        <td class="text-muted">{{ t.num }}</td>
                        <td><span class="badge bg-azure-lt">{{ t.schema }}</span></td>
                        <td><a href="/tables/{{ t.schema }}/{{ t.name }}">{{ t.name }}</a></td>
                        <td>{{ t.rows }}</td>
                        <td>{{ t.size }}</td>
                        <td>{{ t.index_count }}</td>
                        <td>
                            <a class="btn btn-sm btn-outline-secondary" href="/tables/{{ t.schema }}/{{ t.name }}/modal">Detail</a>
                        </td>
                    </tr>
                    {% endfor %}
                {% endif %}
                </tbody>
            </table>
        </div>
        {% if filtered_count > 0 %}
        <div class="card-footer d-flex align-items-center">
            <p class="m-0 text-muted">
                Showing {{ showing_start }} - {{ showing_end }} of {{ filtered_count }}
                {% if filtered_count != total_count %}
                    ({{ total_count }} total)
                {% endif %}
            </p>
            {% if total_pages > 1 %}
            <ul class="pagination m-0 ms-auto">
                <!-- Previous -->
                {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="#"
                       hx-get="/tables/table?filter={{ filter }}&page={{ page - 1 }}&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                       hx-target="#tables-table"
                       hx-swap="outerHTML">
                        <i class="ti ti-chevron-left"></i> Prev
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link"><i class="ti ti-chevron-left"></i> Prev</span>
                </li>
                {% endif %}

                <!-- Page numbers -->
                {% if page > 2 %}
                <li class="page-item">
                    <a class="page-link" href="#"
                       hx-get="/tables/table?filter={{ filter }}&page=1&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                       hx-target="#tables-table"
                       hx-swap="outerHTML">
                        1
                    </a>
                </li>
                {% if page > 3 %}
                <li class="page-item disabled"><span class="page-link">…</span></li>
                {% endif %}
                {% endif %}

                {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="#"
                       hx-get="/tables/table?filter={{ filter }}&page={{ page - 1 }}&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                       hx-target="#tables-table"
                       hx-swap="outerHTML">
                        {{ page - 1 }}
                    </a>
                </li>
                {% endif %}

                <li class="page-item active">
                    <span class="page-link">{{ page }}</span>
                </li>

                {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="#"
                       hx-get="/tables/table?filter={{ filter }}&page={{ page + 1 }}&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                       hx-target="#tables-table"
                       hx-swap="outerHTML">
                        {{ page + 1 }}
                    </a>
                </li>
                {% endif %}

                {% if page < total_pages - 1 %}
                {% if page < total_pages - 2 %}
                <li class="page-item disabled"><span class="page-link">…</span></li>
                {% endif %}
                <li class="page-item">
                    <a class="page-link" href="#"
                       hx-get="/tables/table?filter={{ filter }}&page={{ total_pages }}&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                       hx-target="#tables-table"
                       hx-swap="outerHTML">
                        {{ total_pages }}
                    </a>
                </li>
                {% endif %}

                <!-- Next -->
                {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="#"
                       hx-get="/tables/table?filter={{ filter }}&page={{ page + 1 }}&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                       hx-target="#tables-table"
                       hx-swap="outerHTML">
                        Next <i class="ti ti-chevron-right"></i>
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">Next <i class="ti ti-chevron-right"></i></span>
                </li>
                {% endif %}
            </ul>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<script>
// Sortable headers
document.querySelectorAll('.sortable').forEach(th => {
    th.style.cursor = 'pointer';
    th.addEventListener('click', function() {
        const sortBy = this.dataset.sort;
        const currentSortBy = '{{ sort_by }}';
        const currentSortOrder = '{{ sort_order }}';

        let newSortOrder = 'asc';
        if (sortBy === currentSortBy && currentSortOrder === 'asc') {
            newSortOrder = 'desc';
        }

        const filter = document.getElementById('filter-input').value;
        const perPage = document.querySelector('[name="per_page"]').value;

        htmx.ajax('GET', `/tables/table?filter=${encodeURIComponent(filter)}&page=1&per_page=${perPage}&sort_by=${sortBy}&sort_order=${newSortOrder}`, {
            target: '#tables-table',
            swap: 'outerHTML'
        });
    });
});
</script>
