{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}
{% block nav_indices %}active{% endblock %}
{% block page_title %}Indexes{% endblock %}
{% block content %}
<div class="row row-cards mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="row align-items-end g-2">
          <div class="col-auto">
            <label class="form-label">Schema</label>
            <select class="form-select" id="schema-select" onchange="applySchemaFilter()">
              <option value="*">*</option>
              {% for s in schemas %}
                <option value="{{ s }}">{{ s }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-auto">
            <label class="form-label">Table</label>
            <select class="form-select" id="table-select" onchange="applyTableFilter()">
              <option value="*">*</option>
              {% for t in tables %}
                <option value="{{ t }}">{{ t }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col">
            <label class="form-label">Index filter (wildcard * / OR / AND NOT)</label>
            <input
              type="text"
              class="form-control"
              id="filter-input"
              name="filter"
              placeholder="idx_*, *pkey, * -temp*"
              value="{{ filter }}"
              oninput="handleIndexFilterInput(this)">
          </div>
          <div class="col-auto">
            <label class="form-label">Per page</label>
            <select class="form-select" id="per-page-select" onchange="applyPerPageChange()">
              <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
              <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
              <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
              <option value="250" {% if per_page == 250 %}selected{% endif %}>250</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row row-cards">
  <div class="col-12">
    <div id="indices-table">
      {{- initial_table_html|safe -}}
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="index-info-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Index info</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="index-info-modal-content">
        <div class="text-muted">Loadingâ€¦</div>
      </div>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="reindex-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Reindex index</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">Reindex <code id="reindex-index-name"></code>?</p>
        <div id="reindex-result" class="alert alert-info d-none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-ghost-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="reindex-confirm">Reindex</button>
      </div>
    </div>
  </div>
</div>

<script>
if (typeof window.indicesFilterTimer === 'undefined') {
  window.indicesFilterTimer = null;
}

function currentSort() {
  const card = document.querySelector('#indices-table .card');
  return {
    sortBy: card ? (card.dataset.sortBy || 'size') : 'size',
    sortOrder: card ? (card.dataset.sortOrder || 'desc') : 'desc'
  };
}

function buildIndicesUrl(page = 1) {
  const schema = document.getElementById('schema-select')?.value || '*';
  const table = document.getElementById('table-select')?.value || '*';
  const filter = (document.getElementById('filter-input')?.value || '*').trim() || '*';
  const perPage = document.getElementById('per-page-select')?.value || '50';
  const sort = currentSort();
  const base = window.__BASE_PATH__ || '';
  return `${base}/tables/indices/table?schema=${encodeURIComponent(schema)}&table=${encodeURIComponent(table)}&filter=${encodeURIComponent(filter)}&page=${page}&per_page=${perPage}&sort_by=${sort.sortBy}&sort_order=${sort.sortOrder}`;
}

function loadIndices(url) {
  const target = document.getElementById('indices-table');
  if (!target) return;
  fetch(url, { method: 'GET' })
    .then(res => res.text())
    .then(html => { target.innerHTML = html; })
    .catch(err => { target.innerHTML = `<div class="text-danger">Failed to load indices: ${err}</div>`; });
}

window.handleIndexFilterInput = function(input) {
  clearTimeout(window.indicesFilterTimer);
  window.indicesFilterTimer = setTimeout(() => {
    loadIndices(buildIndicesUrl(1));
  }, 350);
};

window.applyPerPageChange = function() {
  loadIndices(buildIndicesUrl(1));
};

window.applySchemaFilter = function() {
  const schema = document.getElementById('schema-select')?.value || '*';
  const tableSelect = document.getElementById('table-select');
  if (tableSelect) {
    tableSelect.innerHTML = '<option value="*">*</option>';
  }

  const base = window.__BASE_PATH__ || '';
  if (schema === '*') {
    loadIndices(buildIndicesUrl(1));
    return;
  }

  fetch(`${base}/tables/indices/tables?schema=${encodeURIComponent(schema)}`, { method: 'GET' })
    .then(res => res.json())
    .then(data => {
      if (tableSelect && data && Array.isArray(data.tables)) {
        data.tables.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t;
          opt.textContent = t;
          tableSelect.appendChild(opt);
        });
      }
      loadIndices(buildIndicesUrl(1));
    })
    .catch(() => loadIndices(buildIndicesUrl(1)));
};

window.applyTableFilter = function() {
  loadIndices(buildIndicesUrl(1));
};

document.addEventListener('click', function(evt) {
  const el = evt.target.closest('[hx-get]');
  if (!el) return;
  const url = el.getAttribute('hx-get');
  if (!url) return;
  evt.preventDefault();
  loadIndices(url);
});

function openIndexInfo(button) {
  const schema = button.dataset.schema;
  const index = button.dataset.index;
  if (!schema || !index) return;
  const base = window.__BASE_PATH__ || '';
  fetch(`${base}/tables/indices/${encodeURIComponent(schema)}/${encodeURIComponent(index)}/info`, { method: 'GET' })
    .then(res => res.text())
    .then(html => {
      const target = document.getElementById('index-info-modal-content');
      if (target) target.innerHTML = html;
      const modal = new bootstrap.Modal(document.getElementById('index-info-modal'));
      modal.show();
    })
    .catch(err => {
      const target = document.getElementById('index-info-modal-content');
      if (target) target.innerHTML = `<div class="text-danger">Failed to load info: ${err}</div>`;
    });
}

let pendingReindex = { schema: null, index: null };
window.confirmReindexIndex = function(button) {
  pendingReindex.schema = button.dataset.schema;
  pendingReindex.index = button.dataset.index;
  const label = document.getElementById('reindex-index-name');
  const result = document.getElementById('reindex-result');
  if (label) label.textContent = `${pendingReindex.schema}.${pendingReindex.index}`;
  if (result) {
    result.classList.add('d-none');
    result.textContent = '';
  }
  const modal = new bootstrap.Modal(document.getElementById('reindex-modal'));
  modal.show();
};

document.getElementById('reindex-confirm')?.addEventListener('click', function() {
  if (!pendingReindex.schema || !pendingReindex.index) return;
  const base = window.__BASE_PATH__ || '';
  const result = document.getElementById('reindex-result');
  const url = `${base}/maintenance/reindex-index/${encodeURIComponent(pendingReindex.schema)}/${encodeURIComponent(pendingReindex.index)}`;
  fetch(url, { method: 'POST' })
    .then(res => res.text())
    .then(text => {
      if (result) {
        result.textContent = text;
        result.classList.remove('d-none');
      }
      const modal = bootstrap.Modal.getInstance(document.getElementById('reindex-modal'));
      if (modal) modal.hide();
    })
    .catch(err => {
      if (result) {
        result.textContent = `Failed: ${err}`;
        result.classList.remove('d-none');
      }
    });
});

// Initialize selects from server values
(function() {
  const schemaSelect = document.getElementById('schema-select');
  if (schemaSelect) schemaSelect.value = '{{ selected_schema }}';
  const tableSelect = document.getElementById('table-select');
  if (tableSelect) tableSelect.value = '{{ selected_table }}';
})();
</script>
{% endblock %}
