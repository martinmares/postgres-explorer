{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}
{% block nav_tables %}active{% endblock %}
{% block page_title %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb breadcrumb-dots my-0">
        <li class="breadcrumb-item">
            <a href="{% if ctx.base_path == "/" %}/tables/{{ schema }}/*{% else %}{{ ctx.base_path }}/tables/{{ schema }}/*{% endif %}">
                {{ schema }}
            </a>
        </li>
        <li class="breadcrumb-item active">{{ name }}</li>
    </ol>
</nav>
{% endblock %}
{% block content %}

<!-- Tabs Navigation -->
<div class="card">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <a href="#tab-overview" class="nav-link active" data-bs-toggle="tab" aria-selected="true" role="tab">
          <i class="ti ti-info-circle me-1"></i>Overview
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a href="#tab-columns" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1">
          <i class="ti ti-columns me-1"></i>Columns
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a href="#tab-indexes" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1">
          <i class="ti ti-sort-ascending me-1"></i>Indexes
        </a>
      </li>
      {% if table_type == "partitioned table" %}
      <li class="nav-item" role="presentation">
        <a href="#tab-partitions" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1">
          <i class="ti ti-layout-distribute-vertical me-1"></i>Partitions
        </a>
      </li>
      {% endif %}
    </ul>
  </div>
  <div class="card-body">
    <div class="tab-content">

      <!-- Tab 1: Overview -->
      <div class="tab-pane active show" id="tab-overview" role="tabpanel">
        <div class="row row-deck row-cards">
          <div class="col-md-3">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small">Rows</div>
                <div class="h3 mb-0">{{ rows }}</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small">Size</div>
                <div class="h3 mb-0">{{ size }}</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small">Indexes</div>
                <div class="h3 mb-0">{{ index_count }}</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small">Type</div>
                <div class="h3 mb-0">
                  {% if table_type == "partitioned table" %}
                    <span class="badge bg-purple-lt text-purple-fg">{{ table_type }}</span>
                  {% else %}
                    <span class="badge bg-blue-lt text-blue-fg">{{ table_type }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small mb-2">Fragmentation</div>
                {% if authorized %}
                  <div class="h4 mb-1">{{ fragmentation }}</div>
                  <div class="text-muted small">{{ vacuum_hint }}</div>
                {% else %}
                  {% include "partials/no_authorized.html" %}
                {% endif %}
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small mb-2">Owner</div>
                <div class="h4">{{ owner }}</div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small mb-1">Last Vacuum</div>
                <div>{{ last_vacuum }}</div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small mb-1">Last Analyze</div>
                <div>{{ last_analyze }}</div>
              </div>
            </div>
          </div>

          {% if comment != "" %}
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small mb-1">Comment</div>
                <div>{{ comment }}</div>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Tab 2: Columns -->
      <div class="tab-pane" id="tab-columns" role="tabpanel">
        <div class="text-center py-5">
          <div class="spinner-border text-muted" role="status"></div>
          <div class="mt-2 text-muted">Loading columns...</div>
        </div>
      </div>

      <!-- Tab 3: Indexes -->
      <div class="tab-pane" id="tab-indexes" role="tabpanel">
        <div class="text-center py-5">
          <div class="spinner-border text-muted" role="status"></div>
          <div class="mt-2 text-muted">Loading indexes...</div>
        </div>
      </div>

      <!-- Tab 4: Partitions (jen pro partitioned tables) -->
      {% if table_type == "partitioned table" %}
      <div class="tab-pane" id="tab-partitions" role="tabpanel">
        <div class="text-center py-5">
          <div class="spinner-border text-muted" role="status"></div>
          <div class="mt-2 text-muted">Loading partitions...</div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
</div>

<!-- Modal pro Index DDL -->
<div class="modal modal-blur fade" id="index-ddl-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="index-ddl-title">Index DDL</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <pre id="index-ddl-content" class="bg-dark text-white p-3 rounded" style="font-size: 0.875rem;"></pre>
      </div>
    </div>
  </div>
</div>

<script>
// Lazy load tabs při kliknutí
let columnsLoaded = false;
let indexesLoaded = false;
let partitionsLoaded = false;

document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
  tab.addEventListener('shown.bs.tab', function(e) {
    const target = e.target.getAttribute('href');

    if (target === '#tab-columns' && !columnsLoaded) {
      columnsLoaded = true;
      const url = '{% if ctx.base_path == "/" %}/tables/{{ schema }}/{{ name }}/columns{% else %}{{ ctx.base_path }}/tables/{{ schema }}/{{ name }}/columns{% endif %}';
      fetch(url)
        .then(r => r.text())
        .then(html => {
          document.getElementById('tab-columns').innerHTML = html;
        });
    }

    if (target === '#tab-indexes' && !indexesLoaded) {
      indexesLoaded = true;
      const url = '{% if ctx.base_path == "/" %}/tables/{{ schema }}/{{ name }}/indexes{% else %}{{ ctx.base_path }}/tables/{{ schema }}/{{ name }}/indexes{% endif %}';
      fetch(url)
        .then(r => r.text())
        .then(html => {
          document.getElementById('tab-indexes').innerHTML = html;
        });
    }

    if (target === '#tab-partitions' && !partitionsLoaded) {
      partitionsLoaded = true;
      const url = '{% if ctx.base_path == "/" %}/tables/{{ schema }}/{{ name }}/partitions{% else %}{{ ctx.base_path }}/tables/{{ schema }}/{{ name }}/partitions{% endif %}';
      fetch(url)
        .then(r => r.text())
        .then(html => {
          document.getElementById('tab-partitions').innerHTML = html;
        });
    }
  });
});

function showIndexDDL(name, ddl) {
  document.getElementById('index-ddl-title').textContent = 'Index: ' + name;
  document.getElementById('index-ddl-content').textContent = ddl;
  new bootstrap.Modal(document.getElementById('index-ddl-modal')).show();
}
</script>

{% endblock %}
