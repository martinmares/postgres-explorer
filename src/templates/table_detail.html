{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}
{% block nav_tables %}active{% endblock %}
{% block page_title %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb breadcrumb-dots my-0">
        <li class="breadcrumb-item">
            <a href="{% if ctx.base_path == "/" %}/tables/{{ schema }}/*{% else %}{{ ctx.base_path }}/tables/{{ schema }}/*{% endif %}">
                {{ schema }}
            </a>
        </li>
        <li class="breadcrumb-item active">{{ name }}</li>
    </ol>
</nav>
{% endblock %}
{% block content %}

<!-- Tabs Navigation -->
<div class="card">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <a href="#tab-overview" class="nav-link active" data-bs-toggle="tab" aria-selected="true" role="tab">
          <i class="ti ti-info-circle me-1"></i>Overview
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a href="#tab-columns" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1">
          <i class="ti ti-columns me-1"></i>Columns
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a href="#tab-indexes" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1">
          <i class="ti ti-sort-ascending me-1"></i>Indexes
        </a>
      </li>
      {% if table_type == "partitioned table" %}
      <li class="nav-item" role="presentation">
        <a href="#tab-partitions" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1">
          <i class="ti ti-layout-distribute-vertical me-1"></i>Partitions
        </a>
      </li>
      {% endif %}
      <li class="nav-item" role="presentation">
        <a href="#tab-triggers" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1">
          <i class="ti ti-bolt me-1"></i>Triggers
        </a>
      </li>
    </ul>
  </div>
  <div class="card-body">
    <div class="tab-content">

      <!-- Tab 1: Overview -->
      <div class="tab-pane active show" id="tab-overview" role="tabpanel">
        <div class="row row-deck row-cards">
          <div class="col-md-3">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small">Rows</div>
                <div class="h3 mb-0">{{ rows }}</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small">Size</div>
                <div class="h3 mb-0">{{ size }}</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small">Indexes</div>
                <div class="h3 mb-0">{{ index_count }}</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small">Type</div>
                <div class="h3 mb-0">
                  {% if table_type == "partitioned table" %}
                    <span class="badge bg-purple-lt text-purple-fg">{{ table_type }}</span>
                  {% else %}
                    <span class="badge bg-blue-lt text-blue-fg">{{ table_type }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small mb-2">Fragmentation</div>
                {% if authorized %}
                  <div class="h4 mb-1">{{ fragmentation }}</div>
                  <div class="text-muted small">{{ vacuum_hint }}</div>
                {% else %}
                  {% include "partials/no_authorized.html" %}
                {% endif %}
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small mb-2">Owner</div>
                <div class="h4">{{ owner }}</div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small mb-1">Last Vacuum</div>
                <div>{{ last_vacuum }}</div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small mb-1">Last Analyze</div>
                <div>{{ last_analyze }}</div>
              </div>
            </div>
          </div>

          {% if comment != "" %}
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small mb-1">Comment</div>
                <div>{{ comment }}</div>
              </div>
            </div>
          </div>
          {% endif %}

          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small mb-2">Maintenance Operations</div>
                <div class="btn-list">
                  <button class="btn btn-primary" onclick="runVacuum('{{ schema }}', '{{ name }}')">
                    <i class="ti ti-trash me-1"></i>VACUUM
                  </button>
                  <button class="btn btn-warning" onclick="runVacuumFull('{{ schema }}', '{{ name }}')">
                    <i class="ti ti-trash-x me-1"></i>VACUUM FULL
                  </button>
                  <button class="btn btn-info" onclick="runAnalyzeTable('{{ schema }}', '{{ name }}')">
                    <i class="ti ti-chart-bar me-1"></i>ANALYZE
                  </button>
                </div>
                <div class="text-muted small mt-2">
                  <strong>VACUUM:</strong> Reclaims dead tuple space (non-blocking)<br>
                  <strong>VACUUM FULL:</strong> Completely rebuilds table (locks table, reclaims all bloat)<br>
                  <strong>ANALYZE:</strong> Updates statistics for query planner
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab 2: Columns -->
      <div class="tab-pane" id="tab-columns" role="tabpanel">
        <div class="text-center py-5">
          <div class="spinner-border text-muted" role="status"></div>
          <div class="mt-2 text-muted">Loading columns...</div>
        </div>
      </div>

      <!-- Tab 3: Indexes -->
      <div class="tab-pane" id="tab-indexes" role="tabpanel">
        <div class="text-center py-5">
          <div class="spinner-border text-muted" role="status"></div>
          <div class="mt-2 text-muted">Loading indexes...</div>
        </div>
      </div>

      <!-- Tab 4: Partitions (jen pro partitioned tables) -->
      {% if table_type == "partitioned table" %}
      <div class="tab-pane" id="tab-partitions" role="tabpanel">
        <div class="text-center py-5">
          <div class="spinner-border text-muted" role="status"></div>
          <div class="mt-2 text-muted">Loading partitions...</div>
        </div>
      </div>
      {% endif %}

      <!-- Tab 5: Triggers -->
      <div class="tab-pane" id="tab-triggers" role="tabpanel">
        <div class="text-center py-5">
          <div class="spinner-border text-muted" role="status"></div>
          <div class="mt-2 text-muted">Loading triggers...</div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Modal pro Index DDL -->
<div class="modal modal-blur fade" id="index-ddl-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="index-ddl-title">Index DDL</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <pre id="index-ddl-content" class="bg-dark text-white p-3 rounded" style="font-size: 0.875rem;"></pre>
      </div>
    </div>
  </div>
</div>

<!-- Modal pro Trigger DDL -->
<div class="modal modal-blur fade" id="trigger-ddl-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="trigger-ddl-title">Trigger DDL</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <pre id="trigger-ddl-content" class="bg-dark text-white p-3 rounded" style="font-size: 0.875rem;"></pre>
      </div>
    </div>
  </div>
</div>

<!-- Modal pro REINDEX single -->
<div class="modal modal-blur fade" id="reindex-single-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="ti ti-refresh me-2"></i>REINDEX Index</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Index:</strong> <code id="reindex-single-name"></code></p>
        <div class="alert alert-warning">
          <i class="ti ti-alert-triangle me-2"></i>
          <strong>Warning:</strong> This operation will lock the table during execution.
        </div>
        <p>REINDEX rebuilds the index from scratch, which:</p>
        <ul>
          <li>Removes bloat and reclaims space</li>
          <li>May improve query performance</li>
          <li>Blocks concurrent writes to the table</li>
        </ul>
        <div id="reindex-single-result" class="mt-3" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="reindex-single-confirm">
          <i class="ti ti-refresh me-1"></i>Run REINDEX
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pro REINDEX all -->
<div class="modal modal-blur fade" id="reindex-all-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="ti ti-refresh me-2"></i>REINDEX All Indexes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Table:</strong> <code>{{ schema }}.{{ name }}</code></p>
        <div class="alert alert-warning">
          <i class="ti ti-alert-triangle me-2"></i>
          <strong>Warning:</strong> This will REINDEX all indexes on the table and lock it during execution.
        </div>
        <p>This operation may take several minutes on large tables.</p>
        <div id="reindex-all-result" class="mt-3" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="reindex-all-confirm">
          <i class="ti ti-refresh me-1"></i>Run REINDEX TABLE
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pro VACUUM -->
<div class="modal modal-blur fade" id="vacuum-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="ti ti-trash me-2"></i>VACUUM</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Table:</strong> <code>{{ schema }}.{{ name }}</code></p>
        <div class="alert alert-info">
          <i class="ti ti-info-circle me-2"></i>
          VACUUM is a non-blocking operation that reclaims space from dead tuples.
        </div>
        <p>This operation:</p>
        <ul>
          <li>Marks dead tuple space as reusable</li>
          <li>Does not shrink table files</li>
          <li>Runs concurrently with normal operations</li>
        </ul>
        <div id="vacuum-result" class="mt-3" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="vacuum-confirm">
          <i class="ti ti-trash me-1"></i>Run VACUUM
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pro VACUUM FULL -->
<div class="modal modal-blur fade" id="vacuum-full-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="ti ti-trash-x me-2"></i>VACUUM FULL - Destructive Operation</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Table:</strong> <code>{{ schema }}.{{ name }}</code></p>
        <div class="alert alert-danger">
          <i class="ti ti-alert-triangle me-2"></i>
          <strong>DANGER:</strong> This operation locks the entire table and can take a VERY long time!
        </div>
        <p><strong>What VACUUM FULL does:</strong></p>
        <ul>
          <li>Completely rebuilds the table</li>
          <li>Reclaims ALL bloat and shrinks files</li>
          <li><strong>BLOCKS all reads and writes</strong></li>
          <li>May take hours on large tables</li>
          <li>Requires free disk space (2x table size)</li>
        </ul>
        <p class="text-danger"><strong>Only use this during maintenance windows!</strong></p>
        <div id="vacuum-full-result" class="mt-3" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="vacuum-full-confirm">
          <i class="ti ti-trash-x me-1"></i>I Understand, Run VACUUM FULL
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pro ANALYZE -->
<div class="modal modal-blur fade" id="analyze-table-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="ti ti-chart-bar me-2"></i>ANALYZE Table</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Table:</strong> <code>{{ schema }}.{{ name }}</code></p>
        <div class="alert alert-info">
          <i class="ti ti-info-circle me-2"></i>
          ANALYZE updates table statistics for the query planner. This is a safe, read-only operation.
        </div>
        <p>This helps PostgreSQL:</p>
        <ul>
          <li>Choose optimal query plans</li>
          <li>Use indexes effectively</li>
          <li>Estimate result set sizes accurately</li>
        </ul>
        <div id="analyze-table-result" class="mt-3" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-info" id="analyze-table-confirm">
          <i class="ti ti-chart-bar me-1"></i>Run ANALYZE
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Lazy load tabs při kliknutí
let columnsLoaded = false;
let indexesLoaded = false;
let partitionsLoaded = false;
let triggersLoaded = false;

document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
  tab.addEventListener('shown.bs.tab', function(e) {
    const target = e.target.getAttribute('href');

    if (target === '#tab-columns' && !columnsLoaded) {
      columnsLoaded = true;
      const url = '{% if ctx.base_path == "/" %}/tables/{{ schema }}/{{ name }}/columns{% else %}{{ ctx.base_path }}/tables/{{ schema }}/{{ name }}/columns{% endif %}';
      fetch(url)
        .then(r => r.text())
        .then(html => {
          document.getElementById('tab-columns').innerHTML = html;
        });
    }

    if (target === '#tab-indexes' && !indexesLoaded) {
      indexesLoaded = true;
      const url = '{% if ctx.base_path == "/" %}/tables/{{ schema }}/{{ name }}/indexes{% else %}{{ ctx.base_path }}/tables/{{ schema }}/{{ name }}/indexes{% endif %}';
      fetch(url)
        .then(r => r.text())
        .then(html => {
          document.getElementById('tab-indexes').innerHTML = html;
        });
    }

    if (target === '#tab-partitions' && !partitionsLoaded) {
      partitionsLoaded = true;
      const url = '{% if ctx.base_path == "/" %}/tables/{{ schema }}/{{ name }}/partitions{% else %}{{ ctx.base_path }}/tables/{{ schema }}/{{ name }}/partitions{% endif %}';
      fetch(url)
        .then(r => r.text())
        .then(html => {
          document.getElementById('tab-partitions').innerHTML = html;
          // Init chart po načtení dat
          const dataScript = document.getElementById('partition-chart-data');
          if (dataScript && window.Chart) {
            const data = JSON.parse(dataScript.textContent);
            const ctx = document.getElementById('partition-chart');
            if (ctx) {
              new Chart(ctx, {
                type: 'pie',
                data: {
                  labels: data.labels,
                  datasets: [{
                    data: data.data,
                    backgroundColor: ['#206bc4','#4299e1','#79c0ff','#a4cafe','#d4e4ff','#f0b429','#fab005','#fd7e14','#d63939','#ae3ec9']
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: true,
                  plugins: {
                    legend: {position: 'bottom'},
                    tooltip: {
                      callbacks: {
                        label: function(ctx) {
                          const bytes = ctx.parsed;
                          const units = ['B','KB','MB','GB','TB'];
                          let i = 0;
                          let size = bytes;
                          while (size >= 1024 && i < units.length - 1) { size /= 1024; i++; }
                          return ctx.label + ': ' + size.toFixed(2) + ' ' + units[i];
                        }
                      }
                    }
                  }
                }
              });
            }
          }
        });
    }

    if (target === '#tab-triggers' && !triggersLoaded) {
      triggersLoaded = true;
      const url = '{% if ctx.base_path == "/" %}/tables/{{ schema }}/{{ name }}/triggers{% else %}{{ ctx.base_path }}/tables/{{ schema }}/{{ name }}/triggers{% endif %}';
      fetch(url)
        .then(r => r.text())
        .then(html => {
          document.getElementById('tab-triggers').innerHTML = html;
        });
    }
  });
});

function showIndexDDL(name, ddl) {
  document.getElementById('index-ddl-title').textContent = 'Index: ' + name;
  document.getElementById('index-ddl-content').textContent = ddl;
  new bootstrap.Modal(document.getElementById('index-ddl-modal')).show();
}

function showTriggerDDL(name, ddl) {
  document.getElementById('trigger-ddl-title').textContent = 'Trigger: ' + name;
  document.getElementById('trigger-ddl-content').textContent = ddl;
  new bootstrap.Modal(document.getElementById('trigger-ddl-modal')).show();
}

let currentReindexSchema = '';
let currentReindexIndex = '';

function reindexSingle(schema, indexName) {
  currentReindexSchema = schema;
  currentReindexIndex = indexName;
  document.getElementById('reindex-single-name').textContent = schema + '.' + indexName;
  document.getElementById('reindex-single-result').style.display = 'none';
  document.getElementById('reindex-single-confirm').disabled = false;
  new bootstrap.Modal(document.getElementById('reindex-single-modal')).show();
}

document.getElementById('reindex-single-confirm').addEventListener('click', function() {
  const basePath = '{% if ctx.base_path == "/" %}{% else %}{{ ctx.base_path }}{% endif %}';
  const btn = this;
  const resultDiv = document.getElementById('reindex-single-result');
  const origHtml = btn.innerHTML;

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Running...';

  fetch(basePath + '/maintenance/reindex-index/' + encodeURIComponent(currentReindexSchema) + '/' + encodeURIComponent(currentReindexIndex), { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        resultDiv.innerHTML = '<div class="alert alert-success"><i class="ti ti-check me-2"></i>REINDEX completed successfully!</div>';
        resultDiv.style.display = 'block';
        setTimeout(() => location.reload(), 1500);
      } else {
        resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>' + (data.error || 'Unknown error') + '</div>';
        resultDiv.style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = origHtml;
      }
    })
    .catch(err => {
      resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>' + err.message + '</div>';
      resultDiv.style.display = 'block';
      btn.disabled = false;
      btn.innerHTML = origHtml;
    });
});

function reindexAllIndexes() {
  document.getElementById('reindex-all-result').style.display = 'none';
  document.getElementById('reindex-all-confirm').disabled = false;
  new bootstrap.Modal(document.getElementById('reindex-all-modal')).show();
}

document.getElementById('reindex-all-confirm').addEventListener('click', function() {
  const basePath = '{% if ctx.base_path == "/" %}{% else %}{{ ctx.base_path }}{% endif %}';
  const btn = this;
  const resultDiv = document.getElementById('reindex-all-result');
  const origHtml = btn.innerHTML;

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Running...';

  fetch(basePath + '/maintenance/reindex-table/{{ schema }}/{{ name }}', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        resultDiv.innerHTML = '<div class="alert alert-success"><i class="ti ti-check me-2"></i>REINDEX TABLE completed successfully!</div>';
        resultDiv.style.display = 'block';
        setTimeout(() => location.reload(), 1500);
      } else {
        resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>' + (data.error || 'Unknown error') + '</div>';
        resultDiv.style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = origHtml;
      }
    })
    .catch(err => {
      resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>' + err.message + '</div>';
      resultDiv.style.display = 'block';
      btn.disabled = false;
      btn.innerHTML = origHtml;
    });
});

function runVacuum(schema, table) {
  document.getElementById('vacuum-result').style.display = 'none';
  document.getElementById('vacuum-confirm').disabled = false;
  new bootstrap.Modal(document.getElementById('vacuum-modal')).show();
}

function runVacuumFull(schema, table) {
  document.getElementById('vacuum-full-result').style.display = 'none';
  document.getElementById('vacuum-full-confirm').disabled = false;
  new bootstrap.Modal(document.getElementById('vacuum-full-modal')).show();
}

function runAnalyzeTable(schema, table) {
  document.getElementById('analyze-table-result').style.display = 'none';
  document.getElementById('analyze-table-confirm').disabled = false;
  new bootstrap.Modal(document.getElementById('analyze-table-modal')).show();
}

function setupMaintenanceModal(modalId, operation) {
  document.getElementById(modalId + '-confirm').addEventListener('click', function() {
    const basePath = '{% if ctx.base_path == "/" %}{% else %}{{ ctx.base_path }}{% endif %}';
    const btn = this;
    const resultDiv = document.getElementById(modalId + '-result');
    const origHtml = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Running...';

    fetch(basePath + '/maintenance/' + operation + '/{{ schema }}/{{ name }}', { method: 'POST' })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          resultDiv.innerHTML = '<div class="alert alert-success"><i class="ti ti-check me-2"></i>' + operation.toUpperCase().replace('-', ' ') + ' completed successfully!</div>';
          resultDiv.style.display = 'block';
          setTimeout(() => location.reload(), 1500);
        } else {
          resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>' + (data.error || 'Unknown error') + '</div>';
          resultDiv.style.display = 'block';
          btn.disabled = false;
          btn.innerHTML = origHtml;
        }
      })
      .catch(err => {
        resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>' + err.message + '</div>';
        resultDiv.style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = origHtml;
      });
  });
}

setupMaintenanceModal('vacuum', 'vacuum');
setupMaintenanceModal('vacuum-full', 'vacuum-full');
setupMaintenanceModal('analyze-table', 'analyze');
</script>

{% endblock %}
