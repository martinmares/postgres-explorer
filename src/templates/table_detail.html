{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}
{% block nav_tables %}active{% endblock %}
{% block page_title %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb breadcrumb-dots my-0">
        <li class="breadcrumb-item">
            <a href="{% if ctx.base_path == "/" %}/tables/{{ schema }}/*{% else %}{{ ctx.base_path }}/tables/{{ schema }}/*{% endif %}">
                {{ schema }}
            </a>
        </li>
        <li class="breadcrumb-item active">{{ name }}</li>
    </ol>
</nav>
{% endblock %}
{% block content %}

<!-- Tabs Navigation -->
<div class="card">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <a href="#tab-overview" class="nav-link active" data-bs-toggle="tab" aria-selected="true" role="tab">
          <i class="ti ti-info-circle me-1"></i>Overview
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a href="#tab-columns" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1">
          <i class="ti ti-columns me-1"></i>Columns
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a href="#tab-indexes" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1">
          <i class="ti ti-sort-ascending me-1"></i>Indexes
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a href="#tab-data" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1">
          <i class="ti ti-table me-1"></i>Data
        </a>
      </li>
      {% if table_type == "partitioned table" %}
      <li class="nav-item" role="presentation">
        <a href="#tab-partitions" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1">
          <i class="ti ti-layout-distribute-vertical me-1"></i>Partitions
        </a>
      </li>
      {% endif %}
      <li class="nav-item" role="presentation">
        <a href="#tab-triggers" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1">
          <i class="ti ti-bolt me-1"></i>Triggers
        </a>
      </li>
      <li class="nav-item" role="presentation">
        <a href="#tab-relationships" class="nav-link" data-bs-toggle="tab" aria-selected="false" role="tab" tabindex="-1">
          <i class="ti ti-relation-many-to-many me-1"></i>Relationships
        </a>
      </li>
    </ul>
  </div>
  <div class="card-body">
    <div class="tab-content">

      <!-- Tab 1: Overview -->
      <div class="tab-pane active show" id="tab-overview" role="tabpanel">
        <div class="row row-deck row-cards">
          <div class="col-md-3">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small">Rows</div>
                <div class="h3 mb-0">{{ rows }}</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small">Size</div>
                <div class="h3 mb-0">{{ size }}</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small">Indexes</div>
                <div class="h3 mb-0">{{ index_count }}</div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small">Type</div>
                <div class="h3 mb-0">
                  {% if table_type == "partitioned table" %}
                    <span class="badge bg-purple-lt text-purple-fg">{{ table_type }}</span>
                  {% else %}
                    <span class="badge bg-blue-lt text-blue-fg">{{ table_type }}</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small mb-2">Fragmentation</div>
                {% if authorized %}
                  <div class="h4 mb-1">{{ fragmentation }}</div>
                  <div class="text-muted small">{{ vacuum_hint }}</div>
                {% else %}
                  {% include "partials/no_authorized.html" %}
                {% endif %}
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small mb-2">Owner</div>
                <div class="h4">{{ owner }}</div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small mb-1">Last Vacuum</div>
                <div class="timestamp-display" data-timestamp="{{ last_vacuum }}">Loading...</div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small mb-1">Last Analyze</div>
                <div class="timestamp-display" data-timestamp="{{ last_analyze }}">Loading...</div>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="text-muted small">Autovacuum Settings</div>
                  <button class="btn btn-sm btn-outline-primary" onclick="showAutovacuumSettings()">
                    <i class="ti ti-settings me-1"></i>Configure
                  </button>
                </div>
                <div class="text-muted small">
                  Autovacuum helps prevent table bloat by automatically running VACUUM when enough rows are modified.
                  For high-churn tables (queues), consider lowering thresholds.
                </div>
              </div>
            </div>
          </div>

          {% if comment != "" %}
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small mb-1">Comment</div>
                <div>{{ comment }}</div>
              </div>
            </div>
          </div>
          {% endif %}

          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <div class="text-muted small mb-2">Maintenance Operations</div>
                <div class="btn-list">
                  <button class="btn btn-primary" onclick="runVacuum('{{ schema }}', '{{ name }}')">
                    <i class="ti ti-trash me-1"></i>VACUUM
                  </button>
                  <button class="btn btn-warning" onclick="runVacuumFull('{{ schema }}', '{{ name }}')">
                    <i class="ti ti-trash-x me-1"></i>VACUUM FULL
                  </button>
                  <button class="btn btn-info" onclick="runAnalyzeTable('{{ schema }}', '{{ name }}')">
                    <i class="ti ti-chart-bar me-1"></i>ANALYZE
                  </button>
                </div>
                <div class="text-muted small mt-2">
                  <strong>VACUUM:</strong> Reclaims dead tuple space (non-blocking)<br>
                  <strong>VACUUM FULL:</strong> Completely rebuilds table (locks table, reclaims all bloat)<br>
                  <strong>ANALYZE:</strong> Updates statistics for query planner
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab 2: Columns -->
      <div class="tab-pane" id="tab-columns" role="tabpanel">
        <div class="text-center py-5">
          <div class="spinner-border text-muted" role="status"></div>
          <div class="mt-2 text-muted">Loading columns...</div>
        </div>
      </div>

      <!-- Tab 3: Indexes -->
      <div class="tab-pane" id="tab-indexes" role="tabpanel">
        <div class="text-center py-5">
          <div class="spinner-border text-muted" role="status"></div>
          <div class="mt-2 text-muted">Loading indexes...</div>
        </div>
      </div>

      <!-- Tab 3b: Data -->
      <div class="tab-pane" id="tab-data" role="tabpanel">
        <div class="text-center py-5">
          <div class="spinner-border text-muted" role="status"></div>
          <div class="mt-2 text-muted">Loading data...</div>
        </div>
      </div>

      <!-- Tab 4: Partitions (jen pro partitioned tables) -->
      {% if table_type == "partitioned table" %}
      <div class="tab-pane" id="tab-partitions" role="tabpanel">
        <div class="text-center py-5">
          <div class="spinner-border text-muted" role="status"></div>
          <div class="mt-2 text-muted">Loading partitions...</div>
        </div>
      </div>
      {% endif %}

      <!-- Tab 5: Triggers -->
      <div class="tab-pane" id="tab-triggers" role="tabpanel">
        <div class="text-center py-5">
          <div class="spinner-border text-muted" role="status"></div>
          <div class="mt-2 text-muted">Loading triggers...</div>
        </div>
      </div>

      <!-- Tab 6: Relationships -->
      <div class="tab-pane" id="tab-relationships" role="tabpanel">
        <div class="text-center py-5">
          <div class="spinner-border text-muted" role="status"></div>
          <div class="mt-2 text-muted">Loading relationships...</div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Modal pro Index DDL -->
<div class="modal modal-blur fade" id="index-ddl-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="index-ddl-title">Index DDL</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <pre id="index-ddl-content" class="bg-dark text-white p-3 rounded" style="font-size: 0.875rem;"></pre>
      </div>
    </div>
  </div>
</div>

<!-- Modal pro Trigger DDL -->
<div class="modal modal-blur fade" id="trigger-ddl-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="trigger-ddl-title">Trigger DDL</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <pre id="trigger-ddl-content" class="bg-dark text-white p-3 rounded" style="font-size: 0.875rem;"></pre>
      </div>
    </div>
  </div>
</div>

<!-- Modal pro REINDEX single -->
<div class="modal modal-blur fade" id="reindex-single-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="ti ti-refresh me-2"></i>REINDEX Index</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Index:</strong> <code id="reindex-single-name"></code></p>
        <div class="alert alert-warning">
          <i class="ti ti-alert-triangle me-2"></i>
          <strong>Warning:</strong> This operation will lock the table during execution.
        </div>
        <p>REINDEX rebuilds the index from scratch, which:</p>
        <ul>
          <li>Removes bloat and reclaims space</li>
          <li>May improve query performance</li>
          <li>Blocks concurrent writes to the table</li>
        </ul>
        <div id="reindex-single-result" class="mt-3" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="reindex-single-confirm">
          <i class="ti ti-refresh me-1"></i>Run REINDEX
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pro REINDEX all -->
<div class="modal modal-blur fade" id="reindex-all-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="ti ti-refresh me-2"></i>REINDEX All Indexes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Table:</strong> <code>{{ schema }}.{{ name }}</code></p>
        <div class="alert alert-warning">
          <i class="ti ti-alert-triangle me-2"></i>
          <strong>Warning:</strong> This will REINDEX all indexes on the table and lock it during execution.
        </div>
        <p>This operation may take several minutes on large tables.</p>
        <div id="reindex-all-result" class="mt-3" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="reindex-all-confirm">
          <i class="ti ti-refresh me-1"></i>Run REINDEX TABLE
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pro VACUUM -->
<div class="modal modal-blur fade" id="vacuum-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="ti ti-trash me-2"></i>VACUUM</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Table:</strong> <code>{{ schema }}.{{ name }}</code></p>
        <div class="alert alert-info">
          <i class="ti ti-info-circle me-2"></i>
          VACUUM is a non-blocking operation that reclaims space from dead tuples.
        </div>
        <p>This operation:</p>
        <ul>
          <li>Marks dead tuple space as reusable</li>
          <li>Does not shrink table files</li>
          <li>Runs concurrently with normal operations</li>
        </ul>
        <div id="vacuum-result" class="mt-3" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="vacuum-confirm">
          <i class="ti ti-trash me-1"></i>Run VACUUM
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pro VACUUM FULL -->
<div class="modal modal-blur fade" id="vacuum-full-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="ti ti-trash-x me-2"></i>VACUUM FULL - Destructive Operation</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Table:</strong> <code>{{ schema }}.{{ name }}</code></p>
        <div class="alert alert-danger">
          <i class="ti ti-alert-triangle me-2"></i>
          <strong>DANGER:</strong> This operation locks the entire table and can take a VERY long time!
        </div>
        <p><strong>What VACUUM FULL does:</strong></p>
        <ul>
          <li>Completely rebuilds the table</li>
          <li>Reclaims ALL bloat and shrinks files</li>
          <li><strong>BLOCKS all reads and writes</strong></li>
          <li>May take hours on large tables</li>
          <li>Requires free disk space (2x table size)</li>
        </ul>
        <p class="text-danger"><strong>Only use this during maintenance windows!</strong></p>
        <div id="vacuum-full-result" class="mt-3" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="vacuum-full-confirm">
          <i class="ti ti-trash-x me-1"></i>I Understand, Run VACUUM FULL
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pro ANALYZE -->
<div class="modal modal-blur fade" id="analyze-table-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="ti ti-chart-bar me-2"></i>ANALYZE Table</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Table:</strong> <code>{{ schema }}.{{ name }}</code></p>
        <div class="alert alert-info">
          <i class="ti ti-info-circle me-2"></i>
          ANALYZE updates table statistics for the query planner. This is a safe, read-only operation.
        </div>
        <p>This helps PostgreSQL:</p>
        <ul>
          <li>Choose optimal query plans</li>
          <li>Use indexes effectively</li>
          <li>Estimate result set sizes accurately</li>
        </ul>
        <div id="analyze-table-result" class="mt-3" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-info" id="analyze-table-confirm">
          <i class="ti ti-chart-bar me-1"></i>Run ANALYZE
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pro Autovacuum Settings -->
<div class="modal modal-blur fade" id="autovacuum-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="ti ti-settings me-2"></i>Autovacuum Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Table:</strong> <code>{{ schema }}.{{ name }}</code></p>
        <div class="alert alert-info">
          <i class="ti ti-info-circle me-2"></i>
          These settings control when autovacuum runs on this specific table. Lower thresholds = more frequent vacuums.
        </div>

        <div class="mb-3">
          <label class="form-label">Autovacuum Scale Factor <span class="text-muted">(fraction of table size)</span></label>
          <input type="number" class="form-control" id="autovacuum-scale-factor" step="0.01" min="0" max="1" placeholder="0.2 (default)">
          <div class="form-text">Triggers autovacuum when (scale_factor * table_size) + threshold dead tuples exist</div>
        </div>

        <div class="mb-3">
          <label class="form-label">Autovacuum Threshold <span class="text-muted">(minimum dead tuples)</span></label>
          <input type="number" class="form-control" id="autovacuum-threshold" min="0" placeholder="50 (default)">
          <div class="form-text">Minimum number of dead tuples before autovacuum triggers</div>
        </div>

        <div class="alert alert-warning">
          <strong>For queue-like tables:</strong> Try scale_factor=0.01 and threshold=100 to vacuum more aggressively
        </div>

        <div id="autovacuum-result" class="mt-3" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger me-2" id="autovacuum-reset">
          <i class="ti ti-x me-1"></i>Reset to Defaults
        </button>
        <button type="button" class="btn btn-primary" id="autovacuum-save">
          <i class="ti ti-check me-1"></i>Apply Settings
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Convert UTC timestamps to local timezone
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.timestamp-display').forEach(el => {
    const timestamp = el.getAttribute('data-timestamp');
    if (!timestamp || timestamp === 'never') {
      el.textContent = timestamp || 'never';
      return;
    }

    const parts = timestamp.match(/^(.+?) \((manual|auto)\)$/);
    if (parts) {
      const isoString = parts[1];
      const type = parts[2];
      try {
        const date = new Date(isoString);
        if (isNaN(date.getTime())) {
          // Invalid date, show original
          el.textContent = timestamp;
          return;
        }
        const formatted = date.toLocaleString(undefined, {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
        el.textContent = formatted + ' (' + type + ')';
      } catch (e) {
        // Keep original if parsing fails
        el.textContent = timestamp;
      }
    } else {
      el.textContent = timestamp;
    }
  });

  // Obnovit aktivní tab po reloadu (per-table)
  const storageKey = 'activeTab_{{ schema }}_{{ name }}';
  const activeTab = sessionStorage.getItem(storageKey);
  if (activeTab) {
    const tabTrigger = document.querySelector('[data-bs-toggle="tab"][href="' + activeTab + '"]');
    if (tabTrigger) {
      const tab = new bootstrap.Tab(tabTrigger);
      tab.show();
    }
  }
});

// Lazy load tabs při kliknutí
let columnsLoaded = false;
let indexesLoaded = false;
let dataLoaded = false;
let partitionsLoaded = false;
let triggersLoaded = false;
let relationshipsLoaded = false;

document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
  tab.addEventListener('shown.bs.tab', function(e) {
    const target = e.target.getAttribute('href');
    // Uložit aktivní tab do sessionStorage (per-table)
    const storageKey = 'activeTab_{{ schema }}_{{ name }}';
    sessionStorage.setItem(storageKey, target);

    if (target === '#tab-columns' && !columnsLoaded) {
      columnsLoaded = true;
      const url = '{% if ctx.base_path == "/" %}/tables/{{ schema }}/{{ name }}/columns{% else %}{{ ctx.base_path }}/tables/{{ schema }}/{{ name }}/columns{% endif %}';
      fetch(url)
        .then(r => r.text())
        .then(html => {
          document.getElementById('tab-columns').innerHTML = html;
        });
    }

    if (target === '#tab-indexes' && !indexesLoaded) {
      indexesLoaded = true;
      const url = '{% if ctx.base_path == "/" %}/tables/{{ schema }}/{{ name }}/indexes{% else %}{{ ctx.base_path }}/tables/{{ schema }}/{{ name }}/indexes{% endif %}';
      fetch(url)
        .then(r => r.text())
        .then(html => {
          document.getElementById('tab-indexes').innerHTML = html;
        });
    }

    if (target === '#tab-data' && !dataLoaded) {
      dataLoaded = true;
      loadTableData(1);
    }

    if (target === '#tab-partitions' && !partitionsLoaded) {
      partitionsLoaded = true;
      const url = '{% if ctx.base_path == "/" %}/tables/{{ schema }}/{{ name }}/partitions{% else %}{{ ctx.base_path }}/tables/{{ schema }}/{{ name }}/partitions{% endif %}';
      fetch(url)
        .then(r => r.text())
        .then(html => {
          document.getElementById('tab-partitions').innerHTML = html;
          // Init chart po načtení dat
          const dataScript = document.getElementById('partition-chart-data');
          if (dataScript && window.Chart) {
            const data = JSON.parse(dataScript.textContent);
            const ctx = document.getElementById('partition-chart');
            if (ctx) {
              new Chart(ctx, {
                type: 'pie',
                data: {
                  labels: data.labels,
                  datasets: [{
                    data: data.data,
                    backgroundColor: ['#206bc4','#4299e1','#79c0ff','#a4cafe','#d4e4ff','#f0b429','#fab005','#fd7e14','#d63939','#ae3ec9']
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: true,
                  plugins: {
                    legend: {position: 'bottom'},
                    tooltip: {
                      callbacks: {
                        label: function(ctx) {
                          const bytes = ctx.parsed;
                          const units = ['B','KB','MB','GB','TB'];
                          let i = 0;
                          let size = bytes;
                          while (size >= 1024 && i < units.length - 1) { size /= 1024; i++; }
                          return ctx.label + ': ' + size.toFixed(2) + ' ' + units[i];
                        }
                      }
                    }
                  }
                }
              });
            }
          }
        });
    }

    if (target === '#tab-triggers' && !triggersLoaded) {
      triggersLoaded = true;
      const url = '{% if ctx.base_path == "/" %}/tables/{{ schema }}/{{ name }}/triggers{% else %}{{ ctx.base_path }}/tables/{{ schema }}/{{ name }}/triggers{% endif %}';
      fetch(url)
        .then(r => r.text())
        .then(html => {
          document.getElementById('tab-triggers').innerHTML = html;
        });
    }

    if (target === '#tab-relationships' && !relationshipsLoaded) {
      relationshipsLoaded = true;
      const url = '{% if ctx.base_path == "/" %}/tables/{{ schema }}/{{ name }}/relationships{% else %}{{ ctx.base_path }}/tables/{{ schema }}/{{ name }}/relationships{% endif %}';
      fetch(url)
        .then(r => r.text())
        .then(html => {
          document.getElementById('tab-relationships').innerHTML = html;
          // Manually trigger Mermaid rendering with current theme
          setTimeout(() => {
            if (typeof mermaid !== 'undefined') {
              // Reinitialize with current theme
              const currentTheme = document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'dark' : 'default';
              mermaid.initialize({
                startOnLoad: false,
                theme: currentTheme,
                securityLevel: 'loose'
              });

              const els = document.querySelectorAll('#tab-relationships .mermaid');
              if (els.length > 0) {
                mermaid.run({ nodes: els });
              }
            }
          }, 100);
        });
    }
  });
});

function loadTableData(page) {
  const basePath = '{% if ctx.base_path == "/" %}{% else %}{{ ctx.base_path }}{% endif %}';
  const url = basePath + '/tables/{{ schema }}/{{ name }}/data?page=' + page + '&per_page=50';
  fetch(url)
    .then(r => r.text())
    .then(html => {
      const target = document.getElementById('tab-data');
      if (target) {
        target.innerHTML = html;
        initFkPreview();
      }
    });
}

let fkPreviewCache = new Map();
let fkPreviewTimer = null;

function initFkPreview() {
  const container = document.getElementById('tab-data');
  if (!container) return;

  if (!document.getElementById('fk-preview-popover')) {
    const pop = document.createElement('div');
    pop.id = 'fk-preview-popover';
    pop.style.position = 'fixed';
    pop.style.zIndex = '10000';
    pop.style.display = 'none';
    pop.style.background = 'var(--tblr-bg-surface)';
    pop.style.border = '1px solid var(--tblr-border-color)';
    pop.style.borderRadius = '8px';
    pop.style.padding = '8px';
    pop.style.boxShadow = '0 10px 28px rgba(0,0,0,0.35)';
    pop.style.maxWidth = '780px';
    pop.style.minWidth = '480px';
    document.body.appendChild(pop);
  }

  container.querySelectorAll('.fk-cell').forEach(el => {
    if (el.dataset.bound) return;
    el.dataset.bound = 'true';
    el.addEventListener('mouseenter', function(e) {
      clearTimeout(fkPreviewTimer);
      const schema = el.dataset.fkSchema;
      const table = el.dataset.fkTable;
      const column = el.dataset.fkColumn;
      const value = el.dataset.fkValue;
      const key = `${schema}.${table}.${column}=${value}`;

      const pop = document.getElementById('fk-preview-popover');
      if (!pop) return;
      pop.innerHTML = "<div class='text-muted small'>Loading…</div>";
      pop.style.display = 'block';
      pop.style.left = (e.clientX + 12) + 'px';
      pop.style.top = (e.clientY + 12) + 'px';

      if (fkPreviewCache.has(key)) {
        pop.innerHTML = fkPreviewCache.get(key);
        requestAnimationFrame(() => positionPopover(e, pop));
        return;
      }

      const basePath = '{% if ctx.base_path == "/" %}{% else %}{{ ctx.base_path }}{% endif %}';
      const url = basePath + '/tables/{{ schema }}/{{ name }}/data/preview?schema=' +
        encodeURIComponent(schema) + '&table=' + encodeURIComponent(table) +
        '&column=' + encodeURIComponent(column) + '&value=' + encodeURIComponent(value);

      fetch(url)
        .then(r => r.text())
        .then(html => {
          fkPreviewCache.set(key, html);
          pop.innerHTML = html;
          requestAnimationFrame(() => positionPopover(e, pop));
        })
        .catch(() => {
          pop.innerHTML = "<div class='text-muted small'>Preview unavailable</div>";
          requestAnimationFrame(() => positionPopover(e, pop));
        });
    });

    el.addEventListener('mouseleave', function() {
      const pop = document.getElementById('fk-preview-popover');
      if (!pop) return;
      fkPreviewTimer = setTimeout(() => {
        pop.style.display = 'none';
      }, 200);
    });
  });
}

function positionPopover(evt, pop) {
  const margin = 12;
  const rect = pop.getBoundingClientRect();
  let left = evt.clientX + margin;
  let top = evt.clientY + margin;
  if (left + rect.width > window.innerWidth - margin) {
    left = window.innerWidth - rect.width - margin;
  }
  if (top + rect.height > window.innerHeight - margin) {
    top = window.innerHeight - rect.height - margin;
  }
  if (left < margin) left = margin;
  if (top < margin) top = margin;
  pop.style.left = left + 'px';
  pop.style.top = top + 'px';
}

function showIndexDDL(name, ddl) {
  document.getElementById('index-ddl-title').textContent = 'Index: ' + name;
  document.getElementById('index-ddl-content').textContent = ddl;
  new bootstrap.Modal(document.getElementById('index-ddl-modal')).show();
}

function showTriggerDDL(name, ddl) {
  document.getElementById('trigger-ddl-title').textContent = 'Trigger: ' + name;
  document.getElementById('trigger-ddl-content').textContent = ddl;
  new bootstrap.Modal(document.getElementById('trigger-ddl-modal')).show();
}

let currentReindexSchema = '';
let currentReindexIndex = '';

function reindexSingle(schema, indexName) {
  currentReindexSchema = schema;
  currentReindexIndex = indexName;
  document.getElementById('reindex-single-name').textContent = schema + '.' + indexName;
  document.getElementById('reindex-single-result').style.display = 'none';
  document.getElementById('reindex-single-confirm').disabled = false;
  new bootstrap.Modal(document.getElementById('reindex-single-modal')).show();
}

document.getElementById('reindex-single-confirm').addEventListener('click', function() {
  const basePath = '{% if ctx.base_path == "/" %}{% else %}{{ ctx.base_path }}{% endif %}';
  const btn = this;
  const resultDiv = document.getElementById('reindex-single-result');
  const origHtml = btn.innerHTML;

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Running...';

  fetch(basePath + '/maintenance/reindex-index/' + encodeURIComponent(currentReindexSchema) + '/' + encodeURIComponent(currentReindexIndex), { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        resultDiv.innerHTML = '<div class="alert alert-success"><i class="ti ti-check me-2"></i>REINDEX completed successfully!</div>';
        resultDiv.style.display = 'block';
        setTimeout(() => {
          // Zavřít modal
          bootstrap.Modal.getInstance(document.getElementById('reindex-single-modal')).hide();
          // Reload indexes tab (jsme v něm, jinak bychom tu tlačítko neviděli)
          indexesLoaded = false;
          const storageKey = 'activeTab_{{ schema }}_{{ name }}';
          sessionStorage.setItem(storageKey, '#tab-indexes');
          const url = basePath + '/tables/{{ schema }}/{{ name }}/indexes';
          fetch(url).then(r => r.text()).then(html => {
            document.getElementById('tab-indexes').innerHTML = html;
          });
        }, 1500);
      } else {
        resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>' + (data.error || 'Unknown error') + '</div>';
        resultDiv.style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = origHtml;
      }
    })
    .catch(err => {
      resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>' + err.message + '</div>';
      resultDiv.style.display = 'block';
      btn.disabled = false;
      btn.innerHTML = origHtml;
    });
});

function reindexAllIndexes() {
  document.getElementById('reindex-all-result').style.display = 'none';
  document.getElementById('reindex-all-confirm').disabled = false;
  new bootstrap.Modal(document.getElementById('reindex-all-modal')).show();
}

document.getElementById('reindex-all-confirm').addEventListener('click', function() {
  const basePath = '{% if ctx.base_path == "/" %}{% else %}{{ ctx.base_path }}{% endif %}';
  const btn = this;
  const resultDiv = document.getElementById('reindex-all-result');
  const origHtml = btn.innerHTML;

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Running...';

  fetch(basePath + '/maintenance/reindex-table/{{ schema }}/{{ name }}', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        resultDiv.innerHTML = '<div class="alert alert-success"><i class="ti ti-check me-2"></i>REINDEX TABLE completed successfully!</div>';
        resultDiv.style.display = 'block';
        setTimeout(() => {
          // Zavřít modal
          bootstrap.Modal.getInstance(document.getElementById('reindex-all-modal')).hide();
          // Reload indexes tab (jsme v něm, jinak bychom tu tlačítko neviděli)
          indexesLoaded = false;
          const storageKey = 'activeTab_{{ schema }}_{{ name }}';
          sessionStorage.setItem(storageKey, '#tab-indexes');
          const url = basePath + '/tables/{{ schema }}/{{ name }}/indexes';
          fetch(url).then(r => r.text()).then(html => {
            document.getElementById('tab-indexes').innerHTML = html;
          });
        }, 1500);
      } else {
        resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>' + (data.error || 'Unknown error') + '</div>';
        resultDiv.style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = origHtml;
      }
    })
    .catch(err => {
      resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>' + err.message + '</div>';
      resultDiv.style.display = 'block';
      btn.disabled = false;
      btn.innerHTML = origHtml;
    });
});

function runVacuum(schema, table) {
  document.getElementById('vacuum-result').style.display = 'none';
  document.getElementById('vacuum-confirm').disabled = false;
  new bootstrap.Modal(document.getElementById('vacuum-modal')).show();
}

function runVacuumFull(schema, table) {
  document.getElementById('vacuum-full-result').style.display = 'none';
  document.getElementById('vacuum-full-confirm').disabled = false;
  new bootstrap.Modal(document.getElementById('vacuum-full-modal')).show();
}

function runAnalyzeTable(schema, table) {
  document.getElementById('analyze-table-result').style.display = 'none';
  document.getElementById('analyze-table-confirm').disabled = false;
  new bootstrap.Modal(document.getElementById('analyze-table-modal')).show();
}

function setupMaintenanceModal(modalId, operation) {
  document.getElementById(modalId + '-confirm').addEventListener('click', function() {
    const basePath = '{% if ctx.base_path == "/" %}{% else %}{{ ctx.base_path }}{% endif %}';
    const btn = this;
    const resultDiv = document.getElementById(modalId + '-result');
    const origHtml = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Running...';

    fetch(basePath + '/maintenance/' + operation + '/{{ schema }}/{{ name }}', { method: 'POST' })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          resultDiv.innerHTML = '<div class="alert alert-success"><i class="ti ti-check me-2"></i>' + operation.toUpperCase().replace('-', ' ') + ' completed successfully!</div>';
          resultDiv.style.display = 'block';
          setTimeout(() => location.reload(), 1500);
        } else {
          resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>' + (data.error || 'Unknown error') + '</div>';
          resultDiv.style.display = 'block';
          btn.disabled = false;
          btn.innerHTML = origHtml;
        }
      })
      .catch(err => {
        resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>' + err.message + '</div>';
        resultDiv.style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = origHtml;
      });
  });
}

setupMaintenanceModal('vacuum', 'vacuum');
setupMaintenanceModal('vacuum-full', 'vacuum-full');
setupMaintenanceModal('analyze-table', 'analyze');

// Autovacuum settings
function showAutovacuumSettings() {
  document.getElementById('autovacuum-result').style.display = 'none';
  document.getElementById('autovacuum-scale-factor').value = '';
  document.getElementById('autovacuum-threshold').value = '';
  document.getElementById('autovacuum-save').disabled = false;
  document.getElementById('autovacuum-reset').disabled = false;
  new bootstrap.Modal(document.getElementById('autovacuum-modal')).show();
}

document.getElementById('autovacuum-save').addEventListener('click', function() {
  const basePath = '{% if ctx.base_path == "/" %}{% else %}{{ ctx.base_path }}{% endif %}';
  const btn = this;
  const resultDiv = document.getElementById('autovacuum-result');
  const origHtml = btn.innerHTML;

  const scaleFactor = document.getElementById('autovacuum-scale-factor').value;
  const threshold = document.getElementById('autovacuum-threshold').value;

  if (!scaleFactor && !threshold) {
    resultDiv.innerHTML = '<div class="alert alert-warning"><i class="ti ti-alert-triangle me-2"></i>Please enter at least one value</div>';
    resultDiv.style.display = 'block';
    return;
  }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Applying...';

  fetch(basePath + '/maintenance/autovacuum/{{ schema }}/{{ name }}', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      scale_factor: scaleFactor ? parseFloat(scaleFactor) : null,
      threshold: threshold ? parseInt(threshold) : null
    })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      resultDiv.innerHTML = '<div class="alert alert-success"><i class="ti ti-check me-2"></i>Autovacuum settings applied successfully!</div>';
      resultDiv.style.display = 'block';
      setTimeout(() => location.reload(), 1500);
    } else {
      resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>' + (data.error || 'Unknown error') + '</div>';
      resultDiv.style.display = 'block';
      btn.disabled = false;
      btn.innerHTML = origHtml;
    }
  })
  .catch(err => {
    resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>' + err.message + '</div>';
    resultDiv.style.display = 'block';
    btn.disabled = false;
    btn.innerHTML = origHtml;
  });
});

document.getElementById('autovacuum-reset').addEventListener('click', function() {
  const basePath = '{% if ctx.base_path == "/" %}{% else %}{{ ctx.base_path }}{% endif %}';
  const btn = this;
  const resultDiv = document.getElementById('autovacuum-result');
  const origHtml = btn.innerHTML;

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Resetting...';

  fetch(basePath + '/maintenance/autovacuum-reset/{{ schema }}/{{ name }}', { method: 'POST' })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      resultDiv.innerHTML = '<div class="alert alert-success"><i class="ti ti-check me-2"></i>Settings reset to defaults!</div>';
      resultDiv.style.display = 'block';
      setTimeout(() => location.reload(), 1500);
    } else {
      resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>' + (data.error || 'Unknown error') + '</div>';
      resultDiv.style.display = 'block';
      btn.disabled = false;
      btn.innerHTML = origHtml;
    }
  })
  .catch(err => {
    resultDiv.innerHTML = '<div class="alert alert-danger"><i class="ti ti-x me-2"></i>' + err.message + '</div>';
    resultDiv.style.display = 'block';
    btn.disabled = false;
    btn.innerHTML = origHtml;
  });
});
</script>

{% endblock %}
