{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}
{% block nav_patroni %}active{% endblock %}
{% block page_title %}Patroni Cluster{% endblock %}
{% block content %}

<div class="row row-cards" id="patroni-container">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title">Status</h3>
        <div class="d-flex align-items-center gap-2">
          <span class="text-muted small" id="last-update">Loading...</span>
          <select class="form-select form-select-sm" id="refresh-interval" style="width: auto;">
            <option value="0">No refresh</option>
            <option value="5">5 seconds</option>
            <option value="10" selected>10 seconds</option>
            <option value="30">30 seconds</option>
          </select>
        </div>
      </div>
      <div id="patroni-content" class="table-responsive">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="text-muted mt-2">Fetching cluster status...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
const basePath = '{% if ctx.base_path == "/" %}{% else %}{{ ctx.base_path }}{% endif %}';
const STORAGE_KEY = 'patroni_refresh_interval';
if (window.patroniRefreshInterval) {
  clearInterval(window.patroniRefreshInterval);
  window.patroniRefreshInterval = null;
}

function getRoleBadgeClass(role) {
  const r = role.toLowerCase();
  if (r === 'leader' || r === 'master' || r === 'primary') return 'badge bg-green text-green-fg';
  if (r === 'replica' || r === 'standby') return 'badge bg-blue text-blue-fg';
  return 'badge bg-secondary';
}

function getStateBadgeClass(state) {
  const s = state.toLowerCase();
  if (s === 'running' || s === 'streaming') return 'badge bg-green text-green-fg';
  if (s === 'stopped' || s === 'failed') return 'badge bg-red text-red-fg';
  return 'badge bg-yellow text-yellow-fg';
}

function getLagClass(lag) {
  if (lag === null || lag === 0) return 'text-success';
  if (lag < 100) return 'text-warning';
  return 'text-danger';
}

function formatLag(lag) {
  if (lag === null) return '-';
  if (lag === 0) return '0';
  return lag.toLocaleString();
}

function formatBytes(bytes) {
  if (bytes === null || bytes === undefined) return '-';
  if (bytes === 0) return '0 B';
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
}

function getWalLagClass(bytes) {
  if (bytes === null || bytes === 0) return 'text-success';
  if (bytes < 16 * 1024 * 1024) return 'text-success'; // < 16 MB
  if (bytes < 100 * 1024 * 1024) return 'text-warning'; // < 100 MB
  return 'text-danger';
}

async function fetchPatroniStatus() {
  // Guard: only run if we're on the Patroni page
  const contentEl = document.getElementById('patroni-content');
  if (!contentEl) return;

  try {
    const response = await fetch(`${basePath}/patroni/status`);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);

    const nodes = await response.json();

    // Update last update time
    const now = new Date();
    document.getElementById('last-update').textContent =
      `Last update: ${now.toLocaleTimeString()}`;

    // Find first online node with cluster data
    const onlineNode = nodes.find(n => n.online && n.cluster);

    if (!onlineNode) {
      document.getElementById('patroni-content').innerHTML = `
        <div class="alert alert-danger m-3">
          <h4 class="alert-heading">No Patroni nodes available</h4>
          <p>All configured Patroni REST API endpoints are offline or unreachable.</p>
          <hr>
          <p class="mb-0">Configured URLs:</p>
          <ul>
            ${nodes.map(n => `<li><code>${n.url}</code> - ${n.error || 'Unknown error'}</li>`).join('')}
          </ul>
        </div>
      `;
      return;
    }

    const cluster = onlineNode.cluster;
    const members = onlineNode.members_extended || cluster.members;

    let html = `
      <table class="table table-vcenter card-table table-hover table-sm">
        <thead>
          <tr>
            <th>Member</th>
            <th>Host:Port</th>
            <th>Role</th>
            <th>State</th>
            <th class="text-center">TL</th>
            <th>PG Version</th>
            <th>Patroni Ver</th>
            <th class="text-end">Lag (MB)</th>
            <th class="text-end">WAL Lag</th>
            <th class="text-center">Flags</th>
          </tr>
        </thead>
        <tbody>
    `;

    for (const member of members) {
      const roleBadge = getRoleBadgeClass(member.role);
      const stateBadge = getStateBadgeClass(member.state);
      const lagClass = getLagClass(member.lag);
      const walLagClass = getWalLagClass(member.wal_lag_bytes);

      // Build flags
      let flags = [];
      if (member.cluster_unlocked) {
        flags.push('<span class="badge bg-red text-red-fg" title="Cluster is unlocked">UNLOCKED</span>');
      }
      if (member.tags) {
        if (member.tags.nofailover) flags.push('<span class="badge bg-orange" title="Excluded from failover">NoFailover</span>');
        if (member.tags.noloadbalance) flags.push('<span class="badge bg-yellow" title="Excluded from load balancing">NoLB</span>');
        if (member.tags.nosync) flags.push('<span class="badge bg-purple" title="Not a sync standby candidate">NoSync</span>');
      }

      html += `
        <tr>
          <td><strong>${member.name}</strong></td>
          <td><code>${member.host}:${member.port}</code></td>
          <td><span class="badge ${roleBadge}">${member.role}</span></td>
          <td><span class="badge ${stateBadge}">${member.state}</span></td>
          <td class="text-center">${member.timeline !== null && member.timeline !== undefined ? member.timeline : '-'}</td>
          <td class="text-muted">${member.pg_version || '-'}</td>
          <td class="text-muted small">${member.patroni_version || '-'}</td>
          <td class="text-end ${lagClass}"><strong>${formatLag(member.lag)}</strong></td>
          <td class="text-end ${walLagClass}"><strong>${formatBytes(member.wal_lag_bytes)}</strong></td>
          <td class="text-center">${flags.join(' ') || '-'}</td>
        </tr>
      `;
    }

    html += `
        </tbody>
      </table>
      <div class="card-footer text-muted small">
        Cluster: <strong>${cluster.scope}</strong> |
        Source: <code>${onlineNode.url}</code>
      </div>
    `;

    document.getElementById('patroni-content').innerHTML = html;

    // Remove old history and config cards if they exist
    const oldHistory = document.getElementById('patroni-history');
    const oldConfig = document.getElementById('patroni-config');
    if (oldHistory) oldHistory.remove();
    if (oldConfig) oldConfig.remove();

    // Timeline History section
    if (onlineNode.history && onlineNode.history.length > 0) {
      const historyHtml = `
      <div class="col-12 mt-3" id="patroni-history">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Timeline History</h3>
          </div>
          <div class="table-responsive">
            <table class="table table-vcenter card-table table-sm">
              <thead>
                <tr>
                  <th>Timeline</th>
                  <th>LSN</th>
                  <th>Reason</th>
                </tr>
              </thead>
              <tbody>
                ${onlineNode.history.map(entry => `
                  <tr>
                    <td><strong>${entry[0]}</strong></td>
                    <td><code>${entry[1]}</code></td>
                    <td class="text-muted">${entry[2]}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          <div class="card-footer text-muted small">
            Timeline history shows failover and promote events
          </div>
        </div>
      </div>
      `;
      document.getElementById('patroni-container').insertAdjacentHTML('beforeend', historyHtml);
    }

    // Configuration section
    if (onlineNode.config) {
      const cfg = onlineNode.config;
      let configRows = [];

      if (cfg.ttl !== null && cfg.ttl !== undefined) {
        configRows.push(`<tr><td><strong>TTL</strong></td><td>${cfg.ttl}s</td><td class="text-muted">DCS key time-to-live</td></tr>`);
      }
      if (cfg.loop_wait !== null && cfg.loop_wait !== undefined) {
        configRows.push(`<tr><td><strong>Loop Wait</strong></td><td>${cfg.loop_wait}s</td><td class="text-muted">Main loop sleep interval</td></tr>`);
      }
      if (cfg.retry_timeout !== null && cfg.retry_timeout !== undefined) {
        configRows.push(`<tr><td><strong>Retry Timeout</strong></td><td>${cfg.retry_timeout}s</td><td class="text-muted">DCS and PostgreSQL operation retry timeout</td></tr>`);
      }
      if (cfg.maximum_lag_on_failover !== null && cfg.maximum_lag_on_failover !== undefined) {
        configRows.push(`<tr><td><strong>Max Lag on Failover</strong></td><td>${formatBytes(cfg.maximum_lag_on_failover)}</td><td class="text-muted">Maximum replication lag for failover candidate</td></tr>`);
      }
      if (cfg.synchronous_mode !== null && cfg.synchronous_mode !== undefined) {
        const badge = cfg.synchronous_mode ? '<span class="badge bg-green text-green-fg">Enabled</span>' : '<span class="badge bg-secondary">Disabled</span>';
        configRows.push(`<tr><td><strong>Synchronous Mode</strong></td><td>${badge}</td><td class="text-muted">Synchronous replication mode</td></tr>`);
      }
      if (cfg.synchronous_mode_strict !== null && cfg.synchronous_mode_strict !== undefined) {
        const badge = cfg.synchronous_mode_strict ? '<span class="badge bg-orange text-orange-fg">Strict</span>' : '<span class="badge bg-secondary">Normal</span>';
        configRows.push(`<tr><td><strong>Sync Mode Strict</strong></td><td>${badge}</td><td class="text-muted">Prevent leader demotion on sync standby loss</td></tr>`);
      }

      if (configRows.length > 0) {
        const configHtml = `
        <div class="col-12 mt-3" id="patroni-config">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Configuration</h3>
            </div>
            <div class="table-responsive">
              <table class="table table-vcenter card-table table-sm">
                <thead>
                  <tr>
                    <th style="width: 200px;">Parameter</th>
                    <th style="width: 150px;">Value</th>
                    <th>Description</th>
                  </tr>
                </thead>
                <tbody>
                  ${configRows.join('')}
                </tbody>
              </table>
            </div>
            <div class="card-footer text-muted small">
              Patroni cluster configuration from DCS
            </div>
          </div>
        </div>
        `;
        document.getElementById('patroni-container').insertAdjacentHTML('beforeend', configHtml);
      }
    }

  } catch (error) {
    console.error('Failed to fetch Patroni status:', error);
    const contentEl = document.getElementById('patroni-content');
    if (contentEl) {
      contentEl.innerHTML = `
        <div class="alert alert-danger m-3">
          <h4 class="alert-heading">Failed to fetch cluster status</h4>
          <p class="mb-0">Error: ${error.message}</p>
        </div>
      `;
    }
  }
}

function setupRefresh() {
  const select = document.getElementById('refresh-interval');
  const interval = parseInt(select.value || '0', 10);
  localStorage.setItem(STORAGE_KEY, String(interval));

  if (window.patroniRefreshInterval) {
    clearInterval(window.patroniRefreshInterval);
    window.patroniRefreshInterval = null;
  }

  if (interval > 0) {
    window.patroniRefreshInterval = setInterval(fetchPatroniStatus, interval * 1000);
  }
}

// Initialize select value from storage
const select = document.getElementById('refresh-interval');
const stored = localStorage.getItem(STORAGE_KEY);
if (stored !== null && select) {
  select.value = stored;
}

// Setup refresh listener
if (select) {
  select.addEventListener('change', setupRefresh);
}

// Initial fetch immediately + schedule interval (only if on Patroni page)
if (document.getElementById('patroni-content')) {
  fetchPatroniStatus();
  setupRefresh();
}
})();
</script>

{% endblock %}
